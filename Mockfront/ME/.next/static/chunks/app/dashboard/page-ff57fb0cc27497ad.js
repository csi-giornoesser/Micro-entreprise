(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[5105],{1153:(e,t,s)=>{Promise.resolve().then(s.bind(s,5308))},5308:(e,t,s)=>{"use strict";s.r(t),s.d(t,{default:()=>S});var r=s(5155),l=s(2115);function n(){let[e]=(0,l.useState)("client");return{user:function(){switch(e){case"operator":return{id:"operator-".concat(1),role:"operator",name:"Op\xe9rateur ".concat(1),email:"operateur".concat(1,"@lebdf.fr")};case"partner":return{id:"partner-".concat(1),role:"partner",name:"Partenaire ".concat(1),email:"partenaire".concat(1,"@example.fr"),partnerId:1};case"client":return{id:"client-".concat(1),role:"client",name:"Client ".concat(1),email:"client".concat(1,"@example.fr"),clientId:1};default:return null}}(),switchRole:e=>{console.log("Pour changer de r\xf4le, modifie le hook useAuth.ts avec role: '".concat(e,"'"))},can:{seeAllDossiers:"operator"===e,seeCommercial:"operator"===e,seeExports:"operator"===e,createTickets:!0,editDossiers:"operator"===e,seePartnerData:["operator","partner"].includes(e),seeFinancialData:"operator"===e}}}var a=s(2619),i=s(442),o=s(4101),c=s(8386),d=s(3247);function u(e){let{alert:t}=e;if(!t)return null;let s=e=>"string"==typeof e&&""!==e.trim(),l=s(t.subject)?t.subject:s(t.note)?t.note:"";if(!s(l))return null;let n=t.at?new Date(t.at).toLocaleString("fr-FR"):"—",a=t.canal||"—";return(0,r.jsx)("div",{className:"border rounded-md p-3 bg-amber-50 border-amber-200",children:(0,r.jsxs)("div",{className:"flex items-start gap-3",children:[(0,r.jsx)("div",{className:"text-xl",children:"⏰"}),(0,r.jsxs)("div",{className:"flex-1",children:[(0,r.jsxs)("div",{className:"font-semibold",children:["Relance re\xe7ue (",a,") — ",n]}),(0,r.jsx)("div",{className:"text-sm text-gray-800 whitespace-pre-wrap",children:l})]})]})})}s(6886);var m=s(7730);function x(e){let{clientId:t,dossiers:s=[],onCreated:n}=e,[a,i]=(0,l.useState)(()=>{var e;return(null==s||null==(e=s[0])?void 0:e.id)?String(s[0].id):""}),[o,c]=(0,l.useState)(""),[d,u]=(0,l.useState)(""),[m,x]=(0,l.useState)("Moyenne"),[h,g]=(0,l.useState)(!1),[p,b]=(0,l.useState)(null),[j,v]=(0,l.useState)(null),f=(0,l.useMemo)(()=>{let e=!!a&&o.trim().length>2&&d.trim().length>5;return console.log("canSubmit:",e,{dossierId:a,subjectLength:o.trim().length,messageLength:d.trim().length}),e},[a,o,d]);async function N(e){if(console.log("handleSubmit called"),e.preventDefault(),!f||h)return void console.log("Submit blocked:",{canSubmit:f,loading:h});let s={client_id:t,dossier_id:Number(a),subject:o.trim(),priorite:m,message:d.trim(),sender_type:"Client",source:"client_manual_".concat(Date.now(),"_").concat(Math.random().toString(36).substr(2,5)),ouverture:"manuelle"};console.log("Sending payload:",s),b(null),v(null),g(!0);try{let e=await fetch("/api/tickets",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(s)});console.log("Response status:",e.status),console.log("Response headers:",Object.fromEntries(e.headers.entries()));let t=await e.json().catch(e=>(console.error("JSON parse error:",e),{}));if(console.log("Response body:",t),!e.ok){if(409===e.status)throw Error("Un ticket similaire existe d\xe9j\xe0. Veuillez rafra\xeechir la page.");throw Error(t.error||"HTTP ".concat(e.status))}v("Votre ticket a bien \xe9t\xe9 cr\xe9\xe9 ✅"),c(""),u(""),"function"==typeof n&&n(t)}catch(e){console.error("Submit error:",e),b(e.message||String(e))}finally{g(!1)}}return console.log("Component render:",{clientId:t,dossiersCount:s.length,canSubmit:f,loading:h}),(0,r.jsxs)("section",{className:"border rounded p-4 space-y-3",children:[(0,r.jsx)("h3",{className:"font-semibold text-lg",children:"\uD83C\uDD98 Ouvrir un ticket d'assistance"}),(0,r.jsxs)("div",{className:"text-xs bg-gray-100 p-2 rounded",children:[(0,r.jsxs)("div",{children:["clientId: ",t]}),(0,r.jsxs)("div",{children:["dossierId: ",a]}),(0,r.jsxs)("div",{children:["canSubmit: ",f?"true":"false"]}),(0,r.jsxs)("div",{children:["loading: ",h?"true":"false"]})]}),p&&(0,r.jsxs)("div",{className:"text-sm text-red-700 bg-red-50 border border-red-200 p-2 rounded",children:["❌ ",p]}),j&&(0,r.jsx)("div",{className:"text-sm text-green-700 bg-green-50 border border-green-200 p-2 rounded",children:j}),(0,r.jsxs)("form",{onSubmit:N,className:"space-y-3",children:[(0,r.jsxs)("label",{className:"flex flex-col text-sm",children:[(0,r.jsx)("span",{className:"mb-1 font-medium",children:"Dossier concern\xe9"}),(0,r.jsxs)("select",{className:"border rounded p-2",value:a,onChange:e=>i(e.target.value),required:!0,children:[(0,r.jsx)("option",{value:"",disabled:!0,children:"— S\xe9lectionner —"}),s.map(e=>{var t;return(0,r.jsxs)("option",{value:String(e.id),children:["#",e.id," — ",null!=(t=e.statut)?t:"—"," — cr\xe9\xe9 le ",new Date(e.date_creation).toLocaleDateString("fr-FR")]},e.id)})]})]}),(0,r.jsxs)("label",{className:"flex flex-col text-sm",children:[(0,r.jsx)("span",{className:"mb-1 font-medium",children:"Objet"}),(0,r.jsx)("input",{className:"border rounded p-2",value:o,onChange:e=>c(e.target.value),placeholder:"Ex : Probl\xe8me d'upload de pi\xe8ce",required:!0})]}),(0,r.jsxs)("label",{className:"flex flex-col text-sm",children:[(0,r.jsx)("span",{className:"mb-1 font-medium",children:"Priorit\xe9"}),(0,r.jsxs)("select",{className:"border rounded p-2",value:m,onChange:e=>x(e.target.value),children:[(0,r.jsx)("option",{children:"Basse"}),(0,r.jsx)("option",{children:"Moyenne"}),(0,r.jsx)("option",{children:"Haute"})]})]}),(0,r.jsxs)("label",{className:"flex flex-col text-sm",children:[(0,r.jsx)("span",{className:"mb-1 font-medium",children:"Message"}),(0,r.jsx)("textarea",{className:"border rounded p-2 min-h-[120px]",value:d,onChange:e=>u(e.target.value),placeholder:"D\xe9crivez votre demande…",required:!0})]}),(0,r.jsxs)("div",{className:"flex gap-2",children:[(0,r.jsx)("button",{type:"submit",disabled:!f||h,className:"bg-blue-600 text-white px-3 py-2 rounded disabled:opacity-50",onClick:e=>console.log("Button clicked",{canSubmit:f,loading:h}),children:h?"Envoi…":"Cr\xe9er le ticket"}),(0,r.jsx)("span",{className:"text-xs text-gray-500 self-center",children:"Vous recevrez une notification d\xe8s qu'un conseiller r\xe9pond."})]})]})]})}function h(e){let{entries:t}=e;if(!t||0===t.length)return null;let s=t.reduce((e,t)=>{let s=t.category||"G\xe9n\xe9ral";return(e[s]||(e[s]=[])).push(t),e},{});return(0,r.jsxs)("section",{className:"bg-white border rounded p-4",children:[(0,r.jsx)("h3",{className:"text-lg font-semibold mb-3",children:"❓ FAQ"}),(0,r.jsx)("div",{className:"space-y-3",children:Object.entries(s).map(e=>{let[t,s]=e;return(0,r.jsxs)("div",{children:[(0,r.jsx)("h4",{className:"font-medium text-gray-700 mb-2",children:t}),(0,r.jsx)("div",{className:"space-y-2",children:s.map(e=>(0,r.jsxs)("details",{className:"rounded border p-2",children:[(0,r.jsx)("summary",{className:"cursor-pointer font-medium",children:e.question}),(0,r.jsx)("div",{className:"mt-2 text-sm text-gray-700 whitespace-pre-wrap",children:e.answer})]},e.id))})]},t)})})]})}var g=s(5392),p=s(8994);let b=e=>Number.isFinite(Number(e))?Number(e).toLocaleString("fr-FR"):"0",j={blue:{box:"bg-blue-50 border-blue-200",value:"text-blue-800",title:"text-blue-700",sub:"text-blue-600"},orange:{box:"bg-orange-50 border-orange-200",value:"text-orange-800",title:"text-orange-700",sub:"text-orange-600"},green:{box:"bg-green-50 border-green-200",value:"text-green-800",title:"text-green-700",sub:"text-green-600"},red:{box:"bg-red-50 border-red-200",value:"text-red-800",title:"text-red-700",sub:"text-red-600"},purple:{box:"bg-purple-50 border-purple-200",value:"text-purple-800",title:"text-purple-700",sub:"text-purple-600"},indigo:{box:"bg-indigo-50 border-indigo-200",value:"text-indigo-800",title:"text-indigo-700",sub:"text-indigo-600"},teal:{box:"bg-teal-50 border-teal-200",value:"text-teal-800",title:"text-teal-700",sub:"text-teal-600"},emerald:{box:"bg-emerald-50 border-emerald-200",value:"text-emerald-800",title:"text-emerald-700",sub:"text-emerald-600"},lime:{box:"bg-lime-50 border-lime-200",value:"text-lime-800",title:"text-lime-700",sub:"text-lime-600"},gray:{box:"bg-gray-50 border-gray-200",value:"text-gray-800",title:"text-gray-700",sub:"text-gray-600"}};function v(e){var t,s,n,a,i;let{partnerId:o}=e,[c,d]=(0,l.useState)(null),[u,m]=(0,l.useState)(!1),[x,h]=(0,l.useState)(null),g=(0,l.useMemo)(()=>{var e;let t=null==c||null==(e=c.periode)?void 0:e.moisActuel;if(!t)return"—";let[s,r]=t.split("-");return new Date(Number(s),Number(r)-1,1).toLocaleDateString("fr-FR",{year:"numeric",month:"long"})},[null==c||null==(t=c.periode)?void 0:t.moisActuel]);async function p(){let{signal:e}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};try{var t,s;console.log("DEBUT LOAD KPIS"),m(!0),h(null);let r=await fetch("/api/partenaires/".concat(o),{cache:"no-store",signal:e});if(!r.ok)throw Error("HTTP ".concat(r.status));let l=await r.json();console.log("=== DEBUG COMMISSIONS ==="),console.log("Partenaire taux:",null==(t=l.partenaire)?void 0:t.taux_commission),console.log("CA par p\xe9riode:",l.ca_par_periode),console.log("Commissions total partenaire:",null==(s=l.partenaire)?void 0:s.commissions_total),d(function(e){var t;let s=null!=(t=null==e?void 0:e.partenaire)?t:{},r=Array.isArray(null==e?void 0:e.ca_par_periode)?e.ca_par_periode:[],l=Array.isArray(null==e?void 0:e.dossiers)?e.dossiers:[],n=Array.isArray(null==e?void 0:e.factures)?e.factures:[],a=new Date,i=a.toISOString().slice(0,7),o=String(a.getFullYear()),c=new Date(a.getFullYear(),a.getMonth()-1,1).toISOString().slice(0,7),d=new Set(["nouveau","en_cours","en_attente","a_corriger"]),u=l.length,m=l.filter(e=>d.has(e.statut)).length,x=l.filter(e=>"valide"===e.statut).length,h=l.filter(e=>"rejete"===e.statut).length,g=l.filter(e=>(e.blocages||[]).length>0).length,p=u>0?Math.round(x/u*100):0,b=e=>r.find(t=>t.periode===e)||{},j=e=>Number.isFinite(Number(e))?Number(e):0,v=j(s.ca_total),f=j(s.commissions_total),N=j(b(i).ca),y=j(s.taux_commission),D=e=>{let t=null==e?void 0:e.commissions;return null!=t&&Number.isFinite(Number(t))?Number(t):Number((null==e?void 0:e.ca)||0)*y/100},C=r.filter(e=>e.periode===i).reduce((e,t)=>e+D(t),0),w=r.filter(e=>String(e.periode||"").startsWith(o)).reduce((e,t)=>e+j(t.ca),0),_=r.filter(e=>String(e.periode||"").startsWith(o)).reduce((e,t)=>e+D(t),0),A=j(b(c).ca),S=A>0?Math.round((N-A)/A*100):100*(N>0),I=n.filter(e=>["impayee","en_attente"].includes(e.statut)),E=I.reduce((e,t)=>e+j(t.montant),0),k=r.reduce((e,t)=>e+Number(t.dossiers||0),0),P=k>0?Math.round(v/k):0,F=[];return g>0&&F.push("".concat(g," dossier(s) bloqu\xe9(s)")),I.length>0&&F.push("".concat(I.length," facture(s) impay\xe9e(s)")),0===m&&u>0&&F.push("Aucun dossier en cours"),console.log("=== CALCULS DEBUG ==="),console.log("caList:",r),console.log("tauxCommission:",y),console.log("currentMonth:",i),console.log("P\xe9riode courante trouv\xe9e:",r.filter(e=>e.periode===i)),console.log("commissionsMoisActuel calcul\xe9:",C),console.log("commissionsAnnuelles calcul\xe9:",_),{dossiers:{total:u,enCours:m,valides:x,rejetes:h,bloques:g,tauxConversion:p},financier:{caTotal:v,caMoisActuel:N,caAnnuel:w,commissionsTotal:f,commissionsMoisActuel:C,commissionsAnnuelles:_,facturesImpayees:I.length,montantImpaye:E,evolutionMensuelle:S},performance:{tauxCommission:y,moyenneCaParDossier:P,tauxConversion:p},alertes:F,periode:{moisActuel:i,anneeActuelle:o}}}(l))}catch(e){if("AbortError"===e.name)return;console.error("Erreur KPIs:",e),h("Impossible de charger les KPIs")}finally{m(!1)}}(0,l.useEffect)(()=>{if(!o)return;let e=new AbortController;return p({signal:e.signal}),()=>e.abort()},[o]);let v=e=>{let{title:t,value:s,subtitle:l,color:n="gray",trend:a=null,urgent:i=!1}=e,o=j[i?"red":n]||j.gray;return(0,r.jsxs)("div",{className:"border rounded-lg p-4 text-center ".concat(o.box),children:[(0,r.jsx)("div",{className:"text-2xl font-bold ".concat(o.value),children:s}),(0,r.jsx)("div",{className:"text-sm font-medium ".concat(o.title),children:t}),l&&(0,r.jsx)("div",{className:"text-xs mt-1 ".concat(o.sub),children:l}),Number.isFinite(a)&&(0,r.jsxs)("div",{className:"text-xs mt-1 flex items-center justify-center gap-1 ".concat(a>0?"text-green-600":a<0?"text-red-600":"text-gray-600"),children:[(0,r.jsx)("span",{children:a>0?"↗️":a<0?"↘️":"→"}),(0,r.jsxs)("span",{children:[a>0?"+":"",a,"%"]})]})]})};return u&&!c?(0,r.jsxs)("section",{className:"bg-white border rounded-lg p-6",children:[(0,r.jsx)("h3",{className:"text-lg font-semibold mb-4",children:"\uD83D\uDCCA Tableau de Bord"}),(0,r.jsx)("div",{className:"animate-pulse grid grid-cols-2 md:grid-cols-4 gap-4",children:[void 0,void 0,void 0,void 0].map((e,t)=>(0,r.jsx)("div",{className:"h-20 bg-gray-200 rounded"},t))})]}):x&&!c?(0,r.jsxs)("section",{className:"bg-white border rounded-lg p-6",children:[(0,r.jsx)("h3",{className:"text-lg font-semibold mb-4",children:"\uD83D\uDCCA Tableau de Bord"}),(0,r.jsxs)("div",{className:"bg-red-50 border border-red-200 rounded p-4",children:[(0,r.jsxs)("div",{className:"text-red-800",children:["❌ ",x]}),(0,r.jsx)("button",{onClick:()=>p(),className:"mt-2 text-sm bg-red-600 text-white px-3 py-1 rounded hover:bg-red-700",children:"\uD83D\uDD04 R\xe9essayer"})]})]}):c?(0,r.jsxs)("section",{className:"bg-white border rounded-lg p-6",children:[(0,r.jsxs)("div",{className:"flex items-center justify-between mb-6",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("h3",{className:"text-lg font-semibold",children:"\uD83D\uDCCA Tableau de Bord"}),(0,r.jsxs)("p",{className:"text-sm text-gray-600",children:["P\xe9riode : ",g," • Ann\xe9e : ",null!=(a=null==c||null==(s=c.periode)?void 0:s.anneeActuelle)?a:"—"]})]}),(0,r.jsx)("button",{onClick:()=>p(),disabled:u,className:"text-xs bg-blue-100 hover:bg-blue-200 text-blue-700 px-3 py-2 rounded-md disabled:opacity-50",children:"\uD83D\uDD04 Actualiser"})]}),(null!=(i=null==(n=c.alertes)?void 0:n.length)?i:0)>0&&(0,r.jsxs)("div",{className:"mb-6 p-4 bg-orange-50 border border-orange-200 rounded-lg",children:[(0,r.jsxs)("div",{className:"flex items-center gap-2 mb-2",children:[(0,r.jsx)("span",{className:"text-orange-600",children:"⚠️"}),(0,r.jsx)("span",{className:"font-medium text-orange-800",children:"Alertes"})]}),(0,r.jsx)("ul",{className:"text-sm text-orange-700 space-y-1",children:c.alertes.map((e,t)=>(0,r.jsxs)("li",{children:["• ",e]},t))})]}),(0,r.jsxs)("div",{className:"mb-6",children:[(0,r.jsx)("h4",{className:"text-sm font-medium text-gray-700 mb-3",children:"\uD83D\uDCC2 Dossiers"}),(0,r.jsxs)("div",{className:"grid grid-cols-2 md:grid-cols-5 gap-3",children:[(0,r.jsx)(v,{title:"Total",value:b(c.dossiers.total),color:"blue"}),(0,r.jsx)(v,{title:"En cours",value:b(c.dossiers.enCours),color:"orange",urgent:0===c.dossiers.enCours&&c.dossiers.total>0}),(0,r.jsx)(v,{title:"Valid\xe9s",value:b(c.dossiers.valides),color:"green"}),(0,r.jsx)(v,{title:"Bloqu\xe9s",value:b(c.dossiers.bloques),color:"red",urgent:c.dossiers.bloques>0}),(0,r.jsx)(v,{title:"Taux succ\xe8s",value:"".concat(b(c.dossiers.tauxConversion),"%"),color:"purple"})]})]}),(0,r.jsxs)("div",{className:"mb-6",children:[(0,r.jsx)("h4",{className:"text-sm font-medium text-gray-700 mb-3",children:"\uD83D\uDCB0 Chiffre d'affaires"}),(0,r.jsxs)("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-3",children:[(0,r.jsx)(v,{title:"Ce mois",value:"".concat(b(c.financier.caMoisActuel),"€"),subtitle:"CA mensuel",color:"blue",trend:c.financier.evolutionMensuelle}),(0,r.jsx)(v,{title:"Cette ann\xe9e",value:"".concat(b(c.financier.caAnnuel),"€"),subtitle:"CA annuel",color:"indigo"}),(0,r.jsx)(v,{title:"Total historique",value:"".concat(b(c.financier.caTotal),"€"),subtitle:"Depuis cr\xe9ation",color:"green"}),(0,r.jsx)(v,{title:"Moyenne/dossier",value:"".concat(b(c.performance.moyenneCaParDossier),"€"),subtitle:"CA moyen",color:"teal"})]})]}),(0,r.jsxs)("div",{className:"mb-6",children:[(0,r.jsx)("h4",{className:"text-sm font-medium text-gray-700 mb-3",children:"\uD83D\uDCB8 Commissions \xe0 recevoir"}),(0,r.jsxs)("div",{className:"grid grid-cols-2 md:grid-cols-3 gap-3",children:[(0,r.jsx)(v,{title:"Ce mois",value:"".concat(b(c.financier.commissionsMoisActuel),"€"),subtitle:"Taux: ".concat(b(c.performance.tauxCommission),"%"),color:"emerald"}),(0,r.jsx)(v,{title:"Cette ann\xe9e",value:"".concat(b(c.financier.commissionsAnnuelles),"€"),subtitle:"Commissions",color:"green"}),(0,r.jsx)(v,{title:"Total historique",value:"".concat(b(c.financier.commissionsTotal),"€"),subtitle:"Depuis cr\xe9ation",color:"lime"})]})]}),(c.financier.facturesImpayees>0||c.financier.montantImpaye>0)&&(0,r.jsxs)("div",{className:"mb-6",children:[(0,r.jsx)("h4",{className:"text-sm font-medium text-gray-700 mb-3",children:"\uD83E\uDDFE Facturation"}),(0,r.jsxs)("div",{className:"grid grid-cols-2 gap-3",children:[(0,r.jsx)(v,{title:"Factures impay\xe9es",value:b(c.financier.facturesImpayees),color:"red",urgent:!0}),(0,r.jsx)(v,{title:"Montant en attente",value:"".concat(b(c.financier.montantImpaye),"€"),color:"red",urgent:!0})]})]}),(0,r.jsxs)("div",{className:"text-xs text-gray-500 text-center pt-4 border-t",children:["Derni\xe8re actualisation : ",new Date(new Date).toLocaleDateString("fr-FR")," \xe0 ",new Date().toLocaleTimeString("fr-FR")]})]}):null}var f=s(7221),N=s(9841);let y=e=>e?new Date(e).toLocaleDateString("fr-FR"):"—",D=e=>(null!=e?e:0===e)?String(e):"—";function C(e){var t,s,n,a,i,o;let{partnerId:c,data:d}=e,[u,m]=(0,l.useState)({contrats:!0,technique:!1,support:!1});if(!(null==d?void 0:d.partenaire))return null;let x=d.partenaire,h=x.docs||{},g=Array.isArray(h.documentation_tech)?h.documentation_tech:[],p=e=>{let{k:t,icon:s,title:l,count:n,children:a}=e;return(0,r.jsxs)("div",{children:[(0,r.jsxs)("button",{onClick:()=>m(e=>({...e,[t]:!e[t]})),className:"flex items-center justify-between w-full p-3 bg-gray-100 hover:bg-gray-200 rounded-lg",children:[(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[(0,r.jsx)("span",{children:s}),(0,r.jsx)("span",{className:"font-medium",children:l}),n>0&&(0,r.jsx)("span",{className:"bg-blue-100 text-blue-700 px-2 py-1 rounded-full text-xs",children:n})]}),(0,r.jsx)("span",{className:"transition-transform ".concat(u[t]?"rotate-90":""),children:"▶️"})]}),u[t]&&(0,r.jsx)("div",{className:"mt-3 space-y-3",children:a})]})},b=e=>{let{icon:t="\uD83D\uDCC4",title:s,url:l,description:n,type:a,date:i}=e,o=!!l;return(0,r.jsx)("div",{className:"p-3 border rounded-lg ".concat(o?"bg-white hover:bg-gray-50":"bg-gray-50"),children:(0,r.jsxs)("div",{className:"flex items-start justify-between",children:[(0,r.jsxs)("div",{className:"flex items-start gap-3 flex-1",children:[(0,r.jsx)("span",{className:"text-xl",children:t}),(0,r.jsxs)("div",{className:"flex-1",children:[(0,r.jsx)("h5",{className:"font-medium text-gray-900",children:D(s)}),n?(0,r.jsx)("p",{className:"text-sm text-gray-600 mt-1",children:n}):null,(0,r.jsxs)("div",{className:"flex items-center gap-3 mt-2 text-xs text-gray-500",children:[a&&(0,r.jsxs)("span",{children:["Type: ",a]}),i&&(0,r.jsxs)("span",{children:["MAJ: ",y(i)]}),!o&&(0,r.jsx)("span",{className:"text-red-600",children:"Non disponible"})]})]})]}),o&&(0,r.jsx)("div",{className:"flex gap-2 ml-3",children:(0,r.jsx)("button",{onClick:()=>o?window.open(l,"_blank","noopener,noreferrer"):alert("❌ Document non disponible"),className:"bg-blue-600 text-white px-3 py-1 rounded text-xs hover:bg-blue-700",children:"\uD83D\uDC41️ Voir"})})]})})},j=[h.contrat_pdf,h.modalites_collaboration_pdf].filter(Boolean).length,v=g.length;return(0,r.jsxs)("section",{className:"bg-white border rounded-lg p-6",children:[(0,r.jsxs)("div",{className:"flex items-center justify-between mb-6",children:[(0,r.jsx)("h3",{className:"text-lg font-semibold",children:"\uD83D\uDCC4 Espace documentaire"}),(0,r.jsxs)("div",{className:"text-sm text-gray-600",children:["Partenaire: ",(0,r.jsx)("strong",{children:D(x.nom)})]})]}),(0,r.jsxs)("div",{className:"space-y-4",children:[(0,r.jsxs)(p,{k:"contrats",icon:"\uD83D\uDCCB",title:"Contrats de partenariat",count:j,children:[(0,r.jsx)(b,{icon:"\uD83D\uDCCB",title:"Contrat de partenariat principal",url:h.contrat_pdf,description:null==(t=x.contrat)?void 0:t.conditions_commerciales,type:"PDF",date:null==(s=x.contrat)?void 0:s.date_signature}),(0,r.jsx)(b,{icon:"\uD83D\uDCD6",title:"Modalit\xe9s de collaboration",url:h.modalites_collaboration_pdf,type:"PDF"})]}),(0,r.jsx)(p,{k:"technique",icon:"\uD83D\uDD27",title:"Documentation technique",count:v,children:0===v?(0,r.jsx)("div",{className:"ml-8 p-3 bg-gray-50 border rounded text-sm text-gray-600",children:"—"}):g.map((e,t)=>(0,r.jsx)(b,{icon:"\uD83D\uDD27",title:e.type||"Document ".concat(t+1),url:e.url,description:e.description,type:e.format,date:e.updated_at},t))}),(x.referent||Array.isArray(h.liens_utiles))&&(0,r.jsxs)(p,{k:"support",icon:"\uD83D\uDCAC",title:"Support & Contact",count:1,children:[x.referent&&(0,r.jsxs)("div",{className:"p-4 border rounded-lg bg-green-50 text-sm text-green-700",children:[(0,r.jsx)("div",{className:"font-medium text-green-800 mb-2",children:"\uD83D\uDCDE Contacts"}),(0,r.jsxs)("div",{children:[(0,r.jsx)("strong",{children:"R\xe9f\xe9rent:"})," ",D(null==(n=x.referent)?void 0:n.nom)]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("strong",{children:"Email:"})," ",D(null==(a=x.referent)?void 0:a.email)]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("strong",{children:"T\xe9l\xe9phone:"})," ",D(null==(i=x.referent)?void 0:i.telephone)]}),(null==(o=x.referent)?void 0:o.fonction)&&(0,r.jsxs)("div",{children:[(0,r.jsx)("strong",{children:"Fonction:"})," ",x.referent.fonction]})]}),Array.isArray(h.liens_utiles)&&h.liens_utiles.length>0&&(0,r.jsxs)("div",{className:"p-4 border rounded-lg bg-blue-50 text-sm text-blue-700",children:[(0,r.jsx)("div",{className:"font-medium text-blue-800 mb-2",children:"\uD83D\uDD17 Liens utiles"}),(0,r.jsx)("ul",{className:"list-disc pl-5",children:h.liens_utiles.map((e,t)=>(0,r.jsx)("li",{children:(0,r.jsx)("button",{onClick:()=>window.open(e.url,"_blank"),className:"text-blue-600 underline",children:D(e.label||e.url)})},t))})]})]})]}),(0,r.jsx)("div",{className:"mt-6 pt-4 border-t text-xs text-gray-500",children:(0,r.jsxs)("div",{className:"flex justify-between items-center",children:[(0,r.jsx)("div",{children:h.last_updated?(0,r.jsxs)(r.Fragment,{children:["Derni\xe8re mise \xe0 jour documents: ",y(h.last_updated)]}):"—"}),(0,r.jsxs)("div",{children:["Partenaire depuis: ",y(x.created_at)]})]})})]})}function w(){var e,t,s,a,i,o,c,d,u,m,x,h,g,b,j;let{user:y}=n(),[D,w]=(0,l.useState)(null),[_,A]=(0,l.useState)(null),[S,I]=(0,l.useState)(!0);(0,l.useEffect)(()=>{(null==y?void 0:y.partnerId)&&E()},[null==y?void 0:y.partnerId]);let E=async()=>{try{I(!0),A(null);let e=await fetch("/api/partenaires/".concat(y.partnerId),{cache:"no-store"});if(!e.ok)throw Error("HTTP ".concat(e.status));let t=await e.json();w(t)}catch(e){console.error("Erreur chargement partenaire:",e),A("Erreur chargement partenaire")}finally{I(!1)}};if(_)return(0,r.jsx)("div",{className:"p-6 space-y-4",children:(0,r.jsxs)("div",{className:"bg-red-50 border border-red-200 rounded-lg p-6",children:[(0,r.jsx)("h1",{className:"text-xl font-bold text-red-800 mb-2",children:"Erreur de chargement"}),(0,r.jsx)("p",{className:"text-red-700 mb-4",children:_}),(0,r.jsx)("button",{onClick:E,className:"bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700",children:"\uD83D\uDD04 R\xe9essayer"})]})});if(S)return(0,r.jsxs)("div",{className:"p-6",children:[(0,r.jsx)("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-6 mb-6",children:(0,r.jsxs)("div",{className:"animate-pulse",children:[(0,r.jsx)("div",{className:"h-8 bg-blue-200 rounded w-1/3 mb-2"}),(0,r.jsx)("div",{className:"h-4 bg-blue-200 rounded w-1/2"})]})}),(0,r.jsx)("div",{className:"space-y-6",children:[void 0,void 0,void 0,void 0].map((e,t)=>(0,r.jsxs)("div",{className:"bg-white border rounded-lg p-6 animate-pulse",children:[(0,r.jsx)("div",{className:"h-6 bg-gray-200 rounded w-1/4 mb-4"}),(0,r.jsxs)("div",{className:"space-y-3",children:[(0,r.jsx)("div",{className:"h-4 bg-gray-200 rounded"}),(0,r.jsx)("div",{className:"h-4 bg-gray-200 rounded w-3/4"})]})]},t))})]});if(!D||D.error)return(0,r.jsx)("div",{className:"p-6",children:(0,r.jsxs)("div",{className:"bg-yellow-50 border border-yellow-200 rounded-lg p-6",children:[(0,r.jsx)("h1",{className:"text-xl font-bold text-yellow-800 mb-2",children:"Partenaire introuvable"}),(0,r.jsx)("p",{className:"text-yellow-700",children:(null==D?void 0:D.error)||"Impossible de charger les donn\xe9es du partenaire"})]})});let k=D.partenaire||{};D.ca_par_periode,D.factures,D.partner_users;let P=D.dossiers||[];return D.partner_exports_history,k.docs,(0,r.jsxs)("div",{className:"p-6 space-y-6",children:[(0,r.jsx)("div",{className:"bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-200 rounded-lg p-6",children:(0,r.jsxs)("div",{className:"flex items-center justify-between",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("h1",{className:"text-2xl font-bold text-blue-800",children:"\uD83E\uDD1D Espace Partenaire"}),(0,r.jsx)("h2",{className:"text-xl font-semibold mt-1",children:k.nom}),(0,r.jsx)("p",{className:"text-gray-600",children:k.adresse||"—"}),(0,r.jsxs)("div",{className:"flex items-center gap-4 mt-2 text-sm",children:[(0,r.jsx)("span",{className:"px-2 py-1 rounded-full text-xs font-medium ".concat(!1!==k.actif?"bg-green-100 text-green-800":"bg-red-100 text-red-800"),children:!1!==k.actif?"✅ Actif":"❌ Inactif"}),(0,r.jsxs)("span",{className:"text-gray-600",children:[(0,r.jsx)("strong",{children:"Segment:"})," ",k.segment||"—"]}),(0,r.jsxs)("span",{className:"text-gray-600",children:[(0,r.jsx)("strong",{children:"Int\xe9gration:"})," ",k.integration||"—"]})]})]}),(0,r.jsx)("button",{onClick:E,disabled:S,className:"bg-white border border-blue-200 text-blue-700 px-4 py-2 rounded-md hover:bg-blue-50 disabled:opacity-50 transition-colors",children:"\uD83D\uDD04 Actualiser"})]})}),(0,r.jsx)(v,{partnerId:y.partnerId,data:D}),(0,r.jsx)(f.A,{partnerId:y.partnerId,data:D}),(0,r.jsx)(N.A,{partnerId:y.partnerId,data:D}),(0,r.jsx)(p.A,{partnerId:k.id}),(0,r.jsx)(C,{partnerId:y.partnerId,data:D}),(0,r.jsxs)("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[(0,r.jsxs)("details",{className:"bg-white border rounded-lg",children:[(0,r.jsx)("summary",{className:"cursor-pointer p-4 font-semibold bg-gray-50 rounded-t-lg hover:bg-gray-100",children:"\uD83D\uDCCB Informations d\xe9taill\xe9es"}),(0,r.jsxs)("div",{className:"p-4 space-y-3 text-sm",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("strong",{children:"R\xe9f\xe9rent:"})," ",(null==(e=k.referent)?void 0:e.nom)||"—"," — ",(null==(t=k.referent)?void 0:t.email)||"—"," — ",(null==(s=k.referent)?void 0:s.telephone)||"-"]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("strong",{children:"Int\xe9gration:"})," ",k.integration||"-"," — ",(0,r.jsx)("strong",{children:"Facturation:"})," ",k.type_facturation||"-"," — ",(0,r.jsx)("strong",{children:"Commission:"})," ",null!=(b=k.taux_commission)?b:"-","% — ",(0,r.jsx)("strong",{children:"Segment:"})," ",k.segment||"-"]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("strong",{children:"Contrat:"})," sign\xe9 le ",(null==(a=k.contrat)?void 0:a.date_signature)||"-"," — dur\xe9e ",null!=(j=null==(i=k.contrat)?void 0:i.duree_mois)?j:"-"," mois — statut ",(null==(o=k.contrat)?void 0:o.statut)||"-"," — ",(null==(c=k.contrat)?void 0:c.conditions_commerciales)||""]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("strong",{children:"Paiement:"})," ",(null==(d=k.paiement)?void 0:d.mode)||"-"," — IBAN ",(null==(u=k.paiement)?void 0:u.iban)||"-"," — BIC ",(null==(m=k.paiement)?void 0:m.bic)||"-"]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("strong",{children:"Coord. facturation:"})," ",(null==(x=k.coordonnees_facturation)?void 0:x.societe)||"-"," — ",(null==(h=k.coordonnees_facturation)?void 0:h.email_facturation)||"-"," — ",(null==(g=k.coordonnees_facturation)?void 0:g.adresse)||"-"]})]})]}),(0,r.jsxs)("details",{className:"bg-white border rounded-lg lg:col-span-2",children:[(0,r.jsxs)("summary",{className:"cursor-pointer p-4 font-semibold bg-gray-50 rounded-t-lg hover:bg-gray-100",children:["\uD83D\uDCC2 Dossiers du partenaire (",P.length,")"]}),(0,r.jsx)("div",{className:"p-4",children:P.length?(0,r.jsx)("div",{className:"grid gap-2 text-sm max-h-64 overflow-y-auto",children:P.map(e=>(0,r.jsxs)("div",{className:"border-b pb-2",children:[(0,r.jsxs)("span",{className:"font-medium",children:["Dossier #",e.id]})," — statut ",e.statut," — client #",e.client_id," — entreprise #",e.entreprise_id,(e.blocages||[]).length?(0,r.jsxs)("div",{className:"text-red-600 text-xs mt-1",children:["blocages: ",(e.blocages||[]).join(", ")]}):null]},e.id))}):(0,r.jsx)("p",{className:"text-gray-500 text-sm",children:"Aucun dossier"})})]})]}),(0,r.jsxs)("div",{className:"text-center text-xs text-gray-500 py-4 border-t",children:["Dashboard partenaire • Derni\xe8re actualisation: ",new Date().toLocaleString("fr-FR")," • Partenaire #",y.partnerId]})]})}function _(){let{user:e}=n(),[t,s]=(0,l.useState)(null),[a,p]=(0,l.useState)(null),[b,j]=(0,l.useState)(null);if((0,l.useEffect)(()=>{(null==e?void 0:e.clientId)&&fetch("/api/clients/".concat(e.clientId)).then(e=>e.ok?e.json():Promise.reject(e)).then(s).catch(()=>j("Erreur chargement client"))},[null==e?void 0:e.clientId]),(0,l.useEffect)(()=>{var e,s;if(!(null==t||null==(s=t.dossiers)||null==(e=s[0])?void 0:e.entreprise_id))return;let r=t.dossiers[0].entreprise_id;fetch("/api/entreprises/".concat(r)).then(e=>e.ok?e.json():Promise.reject(e)).then(p).catch(()=>console.error("Erreur chargement entreprise"))},[t]),b)return(0,r.jsx)("div",{className:"p-6",children:(0,r.jsx)("p",{children:b})});if(!t)return(0,r.jsx)("div",{className:"p-6",children:"Chargement…"});let v=t.client,f=t.pieces_justificatives||[];t.zone_echange,t.historique_echanges;let N=t.dossiers||[];v.adresse_personnelle,v.adresse_fiscale;let y=t.telechargements_disponibles||[],D=N.length>0?N[0]:null;return(0,r.jsxs)("div",{className:"p-6 space-y-6",children:[(0,r.jsxs)("div",{className:"bg-green-50 border border-green-200 rounded-lg p-6",children:[(0,r.jsxs)("h1",{className:"text-2xl font-bold text-green-800",children:["\uD83D\uDC4B Bonjour ",v.prenom," ",v.nom]}),(0,r.jsxs)("p",{className:"text-green-700",children:[v.email," — ",v.telephone]})]}),(0,r.jsx)(u,{alert:t.alert_relance}),D&&(0,r.jsx)(o.A,{dossier:D}),(0,r.jsx)(m.A,{relances:[],notifications:t.notifications||[]}),a&&(0,r.jsx)(g.A,{data:a}),(0,r.jsx)(c.A,{client:v}),(0,r.jsx)(d.A,{pieces:f,downloads:y,requiredTypes:["Passeport","PhotoIdentite","RIB","CNI"]}),(0,r.jsx)(i.A,{clientId:v.id,dossiers:N,senderType:"Client"}),(0,r.jsx)(x,{clientId:v.id,dossiers:N,onCreated:()=>{}}),(0,r.jsx)(h,{entries:t.faq})]})}function A(){return(0,l.useEffect)(()=>{window.location.href="/crm/dashboard"},[]),(0,r.jsxs)("div",{className:"text-center py-8",children:[(0,r.jsx)("p",{children:"Redirection vers le CRM..."}),(0,r.jsx)(a,{href:"/crm/dashboard",className:"text-blue-600 underline",children:"Ou cliquer ici pour aller au CRM"})]})}function S(){let{user:e,switchRole:t}=n();return e?(0,r.jsxs)("div",{className:"min-h-screen bg-gray-50",children:[(0,r.jsx)("header",{className:"bg-white border-b px-6 py-4",children:(0,r.jsxs)("div",{className:"flex items-center justify-between",children:[(0,r.jsx)("h1",{className:"text-2xl font-bold",children:"Bureau Des Formalit\xe9s"}),(0,r.jsxs)("div",{className:"flex items-center gap-4",children:[(0,r.jsxs)("div",{className:"text-sm text-gray-600",children:["Connect\xe9: ",(0,r.jsx)("strong",{children:e.name})," (",e.role,")",(0,r.jsx)("div",{className:"text-xs",children:e.email})]}),(0,r.jsx)("div",{className:"text-xs text-gray-500 bg-yellow-50 px-2 py-1 rounded",children:"\uD83D\uDCA1 Pour changer: modifie hooks/useAuth.js"})]})]})}),(0,r.jsx)("nav",{className:"bg-white border-b px-6 py-2",children:(0,r.jsxs)("div",{className:"flex gap-4 text-sm",children:[(0,r.jsx)(a,{href:"/dashboard",className:"text-blue-600 font-medium",children:"Dashboard"}),"operator"===e.role&&(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(a,{href:"/crm/dashboard",className:"text-gray-600 hover:text-blue-600",children:"CRM Complet"}),(0,r.jsx)(a,{href:"/crm/tickets",className:"text-gray-600 hover:text-blue-600",children:"Tickets"}),(0,r.jsx)(a,{href:"/crm/commercial",className:"text-gray-600 hover:text-blue-600",children:"Commercial"})]}),"partner"===e.role&&(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(a,{href:"/factures",className:"text-gray-600 hover:text-blue-600",children:"Factures"}),(0,r.jsx)(a,{href:"/exports",className:"text-gray-600 hover:text-blue-600",children:"Exports"})]}),"client"===e.role&&(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(a,{href:"/documents",className:"text-gray-600 hover:text-blue-600",children:"Documents"}),(0,r.jsx)(a,{href:"/aide",className:"text-gray-600 hover:text-blue-600",children:"Aide"})]})]})}),(0,r.jsxs)("main",{children:["operator"===e.role&&(0,r.jsx)(A,{}),"partner"===e.role&&(0,r.jsx)(w,{}),"client"===e.role&&(0,r.jsx)(_,{})]})]}):(0,r.jsx)("div",{className:"min-h-screen bg-gray-50 flex items-center justify-center",children:(0,r.jsx)("div",{children:"Erreur: Utilisateur non d\xe9fini"})})}}},e=>{e.O(0,[2619,3564,8994,9302,1304,8441,1255,7358],()=>e(e.s=1153)),_N_E=e.O()}]);