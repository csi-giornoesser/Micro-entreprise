(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[4295],{475:(e,s,t)=>{"use strict";t.r(s),t.d(s,{default:()=>n});var a=t(5155),l=t(2115),r=t(2619);function n(){var e,s,t,n,c,i;let[d,o]=(0,l.useState)("all"),[u,x]=(0,l.useState)("all"),[m,h]=(0,l.useState)("all"),[p,j]=(0,l.useState)(50),[g,f]=(0,l.useState)(null),[N,v]=(0,l.useState)(null),[b,y]=(0,l.useState)(!0);async function _(){let e=new URLSearchParams;"all"!==d&&e.set("statut",d),"all"!==u&&e.set("priorite",u),"all"!==m&&e.set("operatorId",m),e.set("limit",p.toString()),v(null),y(!0);try{let s=await fetch("/api/tickets?".concat(e.toString()),{cache:"no-store"});if(!s.ok)throw Error("HTTP ".concat(s.status));let t=await s.json();f(t)}catch(e){v(String(e))}finally{y(!1)}}async function w(e,s){try{await fetch("/api/tickets/".concat(e),{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify({statut:s})}),await _()}catch(e){console.error("Erreur changement statut:",e)}}async function k(e,s){try{await fetch("/api/tickets/".concat(e),{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify({assigne_operateur_id:"none"===s?null:parseInt(s)})}),await _()}catch(e){console.error("Erreur assignation:",e)}}(0,l.useEffect)(()=>{_()},[d,u,m,p]);let C=null!=(e=null==g?void 0:g.tickets)?e:[],S=null!=(s=null==g?void 0:g.filters)?s:{},E=null!=(t=S.statuts)?t:[],T=null!=(n=S.priorites)?n:[],D=null!=(c=S.operateurs)?c:[],O=(0,l.useMemo)(()=>{let e={};return E.forEach(s=>e[s]=0),C.forEach(s=>e[s.statut]=(e[s.statut]||0)+1),e},[C,E]);return N?(0,a.jsxs)("main",{className:"p-6",children:[(0,a.jsx)("h1",{className:"text-xl font-bold",children:"Erreur"}),(0,a.jsx)("pre",{className:"mt-2",children:N})]}):b?(0,a.jsx)("main",{className:"p-6",children:"Chargement des tickets…"}):(0,a.jsxs)("main",{className:"p-6 space-y-8",children:[(0,a.jsxs)("div",{className:"flex items-center gap-3",children:[(0,a.jsx)("h1",{className:"text-2xl font-bold",children:"Tickets de support"}),(0,a.jsx)(r,{href:"/crm/dashboard",className:"text-sm text-blue-600 underline",children:"← Retour dashboard"})]}),(0,a.jsxs)("section",{className:"border rounded p-4 space-y-3",children:[(0,a.jsxs)("div",{className:"grid md:grid-cols-4 gap-3",children:[(0,a.jsxs)("label",{className:"flex flex-col text-sm",children:[(0,a.jsx)("span",{className:"mb-1 font-medium",children:"Statut"}),(0,a.jsxs)("select",{className:"border rounded p-2",value:d,onChange:e=>o(e.target.value),children:[(0,a.jsx)("option",{value:"all",children:"Tous"}),E.map(e=>(0,a.jsx)("option",{value:e,children:e},e))]})]}),(0,a.jsxs)("label",{className:"flex flex-col text-sm",children:[(0,a.jsx)("span",{className:"mb-1 font-medium",children:"Priorit\xe9"}),(0,a.jsxs)("select",{className:"border rounded p-2",value:u,onChange:e=>x(e.target.value),children:[(0,a.jsx)("option",{value:"all",children:"Toutes"}),T.map(e=>(0,a.jsx)("option",{value:e,children:e},e))]})]}),(0,a.jsxs)("label",{className:"flex flex-col text-sm",children:[(0,a.jsx)("span",{className:"mb-1 font-medium",children:"Op\xe9rateur"}),(0,a.jsxs)("select",{className:"border rounded p-2",value:m,onChange:e=>h(e.target.value),children:[(0,a.jsx)("option",{value:"all",children:"Tous"}),D.map(e=>(0,a.jsx)("option",{value:e.id,children:e.nom},e.id))]})]}),(0,a.jsxs)("label",{className:"flex flex-col text-sm",children:[(0,a.jsx)("span",{className:"mb-1 font-medium",children:"Limite"}),(0,a.jsxs)("select",{className:"border rounded p-2",value:p,onChange:e=>j(parseInt(e.target.value)),children:[(0,a.jsx)("option",{value:25,children:"25"}),(0,a.jsx)("option",{value:50,children:"50"}),(0,a.jsx)("option",{value:100,children:"100"})]})]})]}),(0,a.jsxs)("div",{className:"flex gap-3",children:[(0,a.jsx)("button",{className:"border rounded px-3 py-2",onClick:()=>{o("all"),x("all"),h("all")},children:"R\xe9initialiser"}),(0,a.jsxs)("div",{className:"text-sm text-gray-600 self-center",children:[C.length," ticket(s) affich\xe9(s) / ",null!=(i=null==g?void 0:g.total)?i:0," total"]})]})]}),(0,a.jsxs)("section",{children:[(0,a.jsx)("h2",{className:"text-xl font-semibold mb-2",children:"\xc9tat des tickets"}),(0,a.jsx)("div",{className:"flex gap-3 flex-wrap",children:Object.entries(O).map(e=>{let[s,t]=e;return(0,a.jsxs)("div",{className:"border rounded p-3",children:[(0,a.jsx)("div",{className:"text-sm text-gray-600",children:s}),(0,a.jsx)("div",{className:"text-2xl font-bold",children:t})]},s)})})]}),(0,a.jsxs)("section",{children:[(0,a.jsx)("h2",{className:"text-xl font-semibold mb-2",children:"Tickets"}),0===C.length?(0,a.jsx)("p",{className:"text-sm text-gray-600",children:"Aucun ticket avec ces filtres."}):(0,a.jsx)("div",{className:"space-y-3",children:C.map(e=>(0,a.jsxs)("div",{className:"border rounded p-4 space-y-2",children:[(0,a.jsxs)("div",{className:"flex items-start justify-between",children:[(0,a.jsxs)("div",{className:"flex-1",children:[(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsxs)(r,{href:"/crm/tickets/".concat(e.id),className:"font-semibold text-blue-600 underline",children:["#",e.id," — ",e.subject]}),(0,a.jsx)("span",{className:"px-2 py-1 rounded text-xs ".concat((e=>{switch(e){case"Nouveau":return"bg-blue-100 text-blue-800";case"En cours":return"bg-yellow-100 text-yellow-800";case"R\xe9solu":return"bg-green-100 text-green-800";case"Ferm\xe9":return"bg-gray-100 text-gray-800";default:return"bg-gray-100"}})(e.statut)),children:e.statut}),(0,a.jsx)("span",{className:"text-sm ".concat((e=>{switch(e){case"Haute":return"text-red-600 font-semibold";case"Moyenne":return"text-orange-600";case"Basse":return"text-gray-600";default:return""}})(e.priorite)),children:e.priorite})]}),(0,a.jsxs)("div",{className:"text-sm text-gray-600 mt-1",children:["Dossier #",(0,a.jsx)(r,{href:"/crm/dashboard",className:"underline",children:e.dossier_id})," — ","Client:",(0,a.jsxs)(r,{href:"/crm/clients/".concat(e.client_id),className:"underline",children:[e.prenom," ",e.nom]})," — ","Cr\xe9\xe9: ",new Date(e.created_at).toLocaleDateString("fr-FR")]}),e.dernier_message&&(0,a.jsxs)("div",{className:"text-sm bg-gray-50 p-2 rounded mt-2",children:[(0,a.jsx)("strong",{children:"Dernier message:"})," ",e.dernier_message,(0,a.jsxs)("span",{className:"text-gray-500 ml-2",children:["(",new Date(e.dernier_event_at).toLocaleDateString("fr-FR"),")"]})]})]}),(0,a.jsxs)("div",{className:"flex gap-2 text-sm",children:[(0,a.jsx)("select",{className:"border rounded px-2 py-1",value:e.statut,onChange:s=>w(e.id,s.target.value),children:E.map(e=>(0,a.jsx)("option",{value:e,children:e},e))}),(0,a.jsxs)("select",{className:"border rounded px-2 py-1",value:e.assigne_operateur_id||"none",onChange:s=>k(e.id,s.target.value),children:[(0,a.jsx)("option",{value:"none",children:"Non assign\xe9"}),D.map(e=>(0,a.jsx)("option",{value:e.id,children:e.nom},e.id))]})]})]}),e.operateur_nom&&(0,a.jsxs)("div",{className:"text-sm text-gray-600",children:["Assign\xe9 \xe0: ",e.operateur_nom," (",e.operateur_email,")"]})]},e.id))})]})]})}},8755:(e,s,t)=>{Promise.resolve().then(t.bind(t,475))}},e=>{e.O(0,[2619,8441,1255,7358],()=>e(e.s=8755)),_N_E=e.O()}]);