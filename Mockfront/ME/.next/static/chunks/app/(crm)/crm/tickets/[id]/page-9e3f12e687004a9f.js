(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[2351],{63:(e,s,t)=>{"use strict";var r=t(7260);t.o(r,"useParams")&&t.d(s,{useParams:function(){return r.useParams}}),t.o(r,"useSearchParams")&&t.d(s,{useSearchParams:function(){return r.useSearchParams}})},243:(e,s,t)=>{"use strict";t.r(s),t.d(s,{default:()=>c});var r=t(5155),a=t(63),n=t(2115),l=t(2619);let i=e=>e?new Date(e).toLocaleString("fr-FR"):"-";function c(){var e,s,t,c,o;let{id:d}=(0,a.useParams)(),[u,m]=(0,n.useState)(null),[x,h]=(0,n.useState)(null),[p,j]=(0,n.useState)(!0),[f,N]=(0,n.useState)(""),[g,b]=(0,n.useState)(!1);async function v(e){try{let s=await fetch("/api/tickets/".concat(d),{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(!s.ok)throw Error("HTTP ".concat(s.status));window.location.reload()}catch(e){console.error("Erreur mise \xe0 jour:",e),alert("Erreur lors de la mise \xe0 jour")}}async function y(){if(f.trim()){b(!0);try{let e=await fetch("/api/tickets/".concat(d,"/events"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({message:f.trim()})});if(!e.ok)throw Error("HTTP ".concat(e.status));N(""),window.location.reload()}catch(e){console.error("Erreur envoi message:",e),alert("Erreur lors de l'envoi du message")}finally{b(!1)}}}if((0,n.useEffect)(()=>{if(!d)return;let e=new AbortController;return j(!0),h(null),fetch("/api/tickets/".concat(d),{cache:"no-store",signal:e.signal}).then(async e=>{if(!e.ok){let s=await e.text().catch(()=>"");throw Error("HTTP ".concat(e.status," ").concat(e.statusText," — ").concat(s))}return e.json()}).then(m).catch(s=>{e.signal.aborted||h(String(s))}).finally(()=>{e.signal.aborted||j(!1)}),()=>e.abort()},[d]),p)return(0,r.jsx)("main",{className:"p-6",children:"Chargement du ticket…"});if(x)return(0,r.jsxs)("main",{className:"p-6 space-y-2",children:[(0,r.jsx)(l,{href:"/crm/tickets",children:"← Retour aux tickets"}),(0,r.jsx)("h1",{className:"text-xl font-bold mt-2",children:"Erreur"}),(0,r.jsx)("pre",{className:"text-sm bg-gray-100 p-3 rounded",children:x})]});if(!(null==u?void 0:u.ticket))return(0,r.jsxs)("main",{className:"p-6",children:[(0,r.jsx)(l,{href:"/crm/tickets",children:"← Retour aux tickets"}),(0,r.jsx)("h1",{className:"text-xl font-bold mt-2",children:"Ticket introuvable"})]});let w=u.ticket,_=null!=(t=u.events)?t:[],C=null!=(c=u.operateurs)?c:[],k=null!=(o=u.references)?o:{};return(0,r.jsxs)("main",{className:"p-6 space-y-6",children:[(0,r.jsxs)("div",{className:"flex items-center gap-3",children:[(0,r.jsx)(l,{href:"/crm/tickets",className:"text-blue-600 underline",children:"← Retour aux tickets"}),(0,r.jsxs)("h1",{className:"text-2xl font-bold",children:["Ticket #",w.id]})]}),(0,r.jsxs)("section",{className:"border rounded p-4 space-y-4",children:[(0,r.jsx)("div",{className:"flex items-start justify-between",children:(0,r.jsxs)("div",{className:"flex-1",children:[(0,r.jsx)("h2",{className:"text-xl font-semibold",children:w.subject}),(0,r.jsxs)("div",{className:"flex items-center gap-3 mt-2",children:[(0,r.jsx)("span",{className:"px-2 py-1 rounded text-sm ".concat((e=>{switch(e){case"Nouveau":return"bg-blue-100 text-blue-800";case"En cours":return"bg-yellow-100 text-yellow-800";case"R\xe9solu":return"bg-green-100 text-green-800";case"Ferm\xe9":return"bg-gray-100 text-gray-800";default:return"bg-gray-100"}})(w.statut)),children:w.statut}),(0,r.jsxs)("span",{className:"text-sm ".concat((e=>{switch(e){case"Haute":return"text-red-600 font-semibold";case"Moyenne":return"text-orange-600";case"Basse":return"text-gray-600";default:return""}})(w.priorite)),children:["Priorit\xe9: ",w.priorite]}),(0,r.jsxs)("span",{className:"text-sm text-gray-600",children:["Cr\xe9\xe9: ",i(w.created_at)]})]})]})}),(0,r.jsxs)("div",{className:"grid md:grid-cols-2 gap-4 text-sm",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("h4",{className:"font-medium",children:"Dossier"}),(0,r.jsxs)("p",{children:["Dossier #",w.dossier_id," — Statut: ",w.dossier_statut,(0,r.jsx)("br",{}),"Cr\xe9\xe9 le: ",i(w.dossier_date_creation),w.commission_partenaire_eur&&(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)("br",{}),"Commission: ",w.commission_partenaire_eur,"€"]})]})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("h4",{className:"font-medium",children:"Client"}),(0,r.jsxs)("p",{children:[(0,r.jsxs)(l,{href:"/crm/clients/".concat(w.client_id),className:"underline",children:[w.prenom," ",w.nom]}),(0,r.jsx)("br",{}),w.email," ",w.telephone&&"• ".concat(w.telephone)]})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("h4",{className:"font-medium",children:"Entreprise"}),(0,r.jsxs)("p",{children:[(0,r.jsx)(l,{href:"/crm/entreprises/".concat(w.entreprise_id),className:"underline",children:w.denomination||"#".concat(w.entreprise_id)}),(0,r.jsx)("br",{}),w.forme]})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("h4",{className:"font-medium",children:"Partenaire"}),(0,r.jsx)("p",{children:(0,r.jsx)(l,{href:"/crm/partenaires/".concat(w.partenaire_id),className:"underline",children:w.partenaire_nom})})]})]}),(0,r.jsxs)("div",{className:"flex gap-3 pt-2 border-t",children:[(0,r.jsxs)("label",{className:"flex flex-col text-sm",children:[(0,r.jsx)("span",{className:"mb-1",children:"Statut"}),(0,r.jsx)("select",{className:"border rounded p-2",value:w.statut,onChange:e=>v({statut:e.target.value}),children:null==(e=k.statuts)?void 0:e.map(e=>(0,r.jsx)("option",{value:e,children:e},e))})]}),(0,r.jsxs)("label",{className:"flex flex-col text-sm",children:[(0,r.jsx)("span",{className:"mb-1",children:"Priorit\xe9"}),(0,r.jsx)("select",{className:"border rounded p-2",value:w.priorite,onChange:e=>v({priorite:e.target.value}),children:null==(s=k.priorites)?void 0:s.map(e=>(0,r.jsx)("option",{value:e,children:e},e))})]}),(0,r.jsxs)("label",{className:"flex flex-col text-sm",children:[(0,r.jsx)("span",{className:"mb-1",children:"Assign\xe9 \xe0"}),(0,r.jsxs)("select",{className:"border rounded p-2",value:w.assigne_operateur_id||"",onChange:e=>v({assigne_operateur_id:e.target.value?parseInt(e.target.value):null}),children:[(0,r.jsx)("option",{value:"",children:"Non assign\xe9"}),C.map(e=>(0,r.jsx)("option",{value:e.id,children:e.nom},e.id))]})]})]}),w.operateur_nom&&(0,r.jsxs)("div",{className:"text-sm text-gray-600 pt-2 border-t",children:["Actuellement assign\xe9 \xe0: ",(0,r.jsx)("strong",{children:w.operateur_nom})," (",w.operateur_email,")"]})]}),(0,r.jsxs)("section",{children:[(0,r.jsxs)("h3",{className:"text-lg font-semibold mb-3",children:["\uD83D\uDCDD Notes internes \xe9quipe",(0,r.jsx)("span",{className:"text-sm font-normal text-gray-600 ml-2",children:"(Visible uniquement par les op\xe9rateurs)"})]}),(0,r.jsx)("div",{className:"space-y-3",children:0===_.length?(0,r.jsx)("p",{className:"text-gray-600",children:"Aucune note pour le moment."}):_.map(e=>(0,r.jsxs)("div",{className:"border rounded p-3 bg-yellow-50",children:[(0,r.jsxs)("div",{className:"flex justify-between items-start mb-2",children:[(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[(0,r.jsx)("span",{className:"text-xs bg-yellow-200 px-2 py-1 rounded",children:"\uD83D\uDC68‍\uD83D\uDCBC INTERNE"}),(0,r.jsx)("span",{className:"text-sm text-gray-600",children:i(e.at)})]}),e.attachments&&(0,r.jsx)("span",{className:"text-xs bg-gray-100 px-2 py-1 rounded",children:"\uD83D\uDCCE Pi\xe8ce jointe"})]}),(0,r.jsx)("div",{className:"whitespace-pre-wrap",children:e.message})]},e.id))})]}),(0,r.jsxs)("section",{children:[(0,r.jsxs)("h3",{className:"text-lg font-semibold mb-3",children:["➕ Ajouter une note interne",(0,r.jsx)("span",{className:"text-sm font-normal text-gray-600 ml-2",children:"(Non visible par le client)"})]}),(0,r.jsxs)("div",{className:"space-y-3",children:[(0,r.jsx)("textarea",{className:"w-full border rounded p-3 h-24 bg-yellow-50",placeholder:"Note interne pour l'\xe9quipe (ex: 'Client contact\xe9 par t\xe9l\xe9phone', 'Documents valid\xe9s', etc.)",value:f,onChange:e=>N(e.target.value),disabled:g}),(0,r.jsxs)("div",{className:"flex gap-2",children:[(0,r.jsx)("button",{className:"bg-yellow-600 text-white px-4 py-2 rounded disabled:opacity-50",onClick:y,disabled:g||!f.trim(),children:g?"Ajout...":"\uD83D\uDCDD Ajouter note interne"}),(0,r.jsx)("button",{className:"border px-4 py-2 rounded",onClick:()=>N(""),disabled:g,children:"Effacer"})]})]})]})]})}},1091:(e,s,t)=>{Promise.resolve().then(t.bind(t,243))}},e=>{e.O(0,[2619,8441,1255,7358],()=>e(e.s=1091)),_N_E=e.O()}]);