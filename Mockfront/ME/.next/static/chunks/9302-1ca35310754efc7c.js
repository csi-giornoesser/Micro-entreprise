"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[9302],{442:(e,t,s)=>{s.d(t,{A:()=>n});var r=s(5155),a=s(2115);function n(e){let{clientId:t,dossiers:s,senderType:n="Op\xe9rateur"}=e,[i,c]=(0,a.useState)(null),[l,o]=(0,a.useState)([]),[d,u]=(0,a.useState)(""),[m,x]=(0,a.useState)(!1),[h,p]=(0,a.useState)(!1),g="Client"===n,b="Op\xe9rateur"===n;async function f(){if(d.trim()&&i){x(!0);try{let e=await fetch("/api/dossiers/".concat(i.id,"/messages"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({sender_type:n,body:d.trim(),send_email:b})});if(!e.ok)throw Error("HTTP ".concat(e.status));let t=await e.json();o(e=>[...e,t.message]),u(""),b&&t.email_sent?alert("Message envoy\xe9 et email automatique exp\xe9di\xe9 \xe0 ".concat(t.client_email)):g&&alert("Message envoy\xe9 \xe0 l'\xe9quipe !")}catch(e){console.error("Erreur envoi message:",e),alert("Erreur lors de l'envoi du message")}finally{x(!1)}}}return((0,a.useEffect)(()=>{s.length>0&&!i&&c(s[0])},[s,i]),(0,a.useEffect)(()=>{i&&(p(!0),fetch("/api/dossiers/".concat(i.id,"/messages"),{cache:"no-store"}).then(e=>e.ok?e.json():Promise.reject(e)).then(e=>o(e.messages||[])).catch(e=>{console.error("Erreur chargement messages:",e),o([])}).finally(()=>p(!1)))},[i]),0===s.length)?(0,r.jsxs)("section",{className:"border rounded p-4",children:[(0,r.jsx)("h3",{className:"text-lg font-semibold mb-3",children:"\uD83D\uDCAC Messagerie"}),(0,r.jsxs)("p",{className:"text-gray-600",children:["Aucun dossier trouv\xe9",g?"":" pour ce client","."]})]}):(0,r.jsxs)("section",{className:"border rounded p-4 space-y-4",children:[(0,r.jsxs)("h3",{className:"text-lg font-semibold",children:["\uD83D\uDCAC ",g?"Messagerie avec votre \xe9quipe":"Messagerie Client",(0,r.jsx)("span",{className:"text-sm font-normal text-gray-600 ml-2",children:g?"(Communication avec nos op\xe9rateurs)":"(Communication directe avec le client)"})]}),s.length>1&&(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block text-sm font-medium mb-1",children:"Dossier \xe0 afficher :"}),(0,r.jsx)("select",{className:"border rounded p-2",value:(null==i?void 0:i.id)||"",onChange:e=>{c(s.find(t=>t.id===parseInt(e.target.value)))},children:s.map(e=>(0,r.jsxs)("option",{value:e.id,children:["Dossier #",e.id," - ",e.statut]},e.id))})]}),i&&(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)("div",{className:"text-sm bg-blue-50 p-2 rounded",children:["\uD83D\uDCC1 ",(0,r.jsxs)("strong",{children:["Dossier #",i.id]})," - Statut: ",i.statut]}),(0,r.jsx)("div",{className:"space-y-3 max-h-96 overflow-y-auto",children:h?(0,r.jsx)("p",{className:"text-gray-600",children:"Chargement des messages..."}):0===l.length?(0,r.jsx)("p",{className:"text-gray-600",children:"Aucun message pour ce dossier."}):l.map(e=>{var t;let s;return(0,r.jsxs)("div",{className:"p-3 rounded ".concat((e=>{switch(e){case"Client":return"bg-blue-50 border-l-4 border-l-blue-500";case"Op\xe9rateur":return"bg-green-50 border-l-4 border-l-green-500";case"Syst\xe8me":return"bg-gray-50 border-l-4 border-l-gray-500";default:return"bg-gray-50"}})(e.sender_type)),children:[(0,r.jsxs)("div",{className:"flex items-center justify-between mb-1",children:[(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[(0,r.jsx)("span",{children:(e=>{switch(e){case"Client":return"\uD83D\uDC64";case"Op\xe9rateur":return"\uD83D\uDC68‍\uD83D\uDCBC";case"Syst\xe8me":return"\uD83E\uDD16";default:return"\uD83D\uDCAC"}})(e.sender_type)}),(0,r.jsx)("strong",{className:"text-sm",children:(t=e.sender_type,g?"Client"===t?"Vous":"Op\xe9rateur"===t?"\xc9quipe":t:t)})]}),(0,r.jsx)("span",{className:"text-xs text-gray-600",children:(s=e.at)?new Date(s).toLocaleString("fr-FR"):"-"})]}),(0,r.jsx)("div",{className:"whitespace-pre-wrap",children:e.body})]},e.id)})}),(0,r.jsxs)("div",{className:"border-t pt-4 space-y-3",children:[(0,r.jsx)("h4",{className:"font-medium",children:g?"✉️ Envoyer un message \xe0 l'\xe9quipe":"✉️ R\xe9pondre au client"}),(0,r.jsx)("textarea",{className:"w-full border rounded p-3 h-24",placeholder:g?"Votre message \xe0 l'\xe9quipe...":"Votre message sera envoy\xe9 au client par email...",value:d,onChange:e=>u(e.target.value),disabled:m}),(0,r.jsxs)("div",{className:"flex gap-2",children:[(0,r.jsx)("button",{className:"bg-blue-600 text-white px-4 py-2 rounded disabled:opacity-50",onClick:f,disabled:m||!d.trim(),children:m?"Envoi...":g?"\uD83D\uDCE4 Envoyer \xe0 l'\xe9quipe":"\uD83D\uDCE7 Envoyer au client"}),(0,r.jsx)("button",{className:"border px-4 py-2 rounded",onClick:()=>u(""),disabled:m,children:"Effacer"})]}),(0,r.jsxs)("p",{className:"text-xs text-gray-600",children:["\uD83D\uDCA1 ",g?"Votre message sera envoy\xe9 \xe0 l'\xe9quipe et ajout\xe9 \xe0 l'historique de votre dossier.":"Le message sera ajout\xe9 \xe0 l'historique et envoy\xe9 automatiquement par email au client."]})]})]})]})}},9841:(e,t,s)=>{s.d(t,{A:()=>c});var r=s(5155),a=s(2115);let n=e=>e?new Date(e).toLocaleDateString("fr-FR"):"—",i=e=>0===e?"0":null!=e?Number(e).toLocaleString("fr-FR"):"—";function c(e){var t,s;let{partnerId:c,data:o}=e,[d,u]=(0,a.useState)({loading:!1,error:null,model:null}),[m,x]=(0,a.useState)(!1),[h,p]=(0,a.useState)({periode:new Date().toISOString().slice(0,7),echeance_jours:30}),[g,b]=(0,a.useState)(!1),[f,j]=(0,a.useState)(null);async function y(){try{u(e=>({...e,loading:!0,error:null}));let e=await fetch("/api/partenaires/".concat(c),{cache:"no-store"});if(!e.ok)throw Error("HTTP ".concat(e.status));v(await e.json())}catch(e){console.error(e),u({loading:!1,error:"Impossible de charger les factures",model:null})}}function v(e){var t;let s=e.partenaire||{},r=Array.isArray(e.ca_par_periode)?e.ca_par_periode:[],a=Array.isArray(e.factures)?[...e.factures]:[],n=Number(s.taux_commission)||0,i=new Date().toISOString().slice(0,7),c=Number(null==(t=r.find(e=>e.periode===i))?void 0:t.ca)||0,l=Number((c*n/100).toFixed(2)),o=new Date().getFullYear().toString(),d=Number((r.filter(e=>String(e.periode||"").startsWith(o)).reduce((e,t)=>e+(Number(t.ca)||0),0)*n/100).toFixed(2)),m=a.filter(e=>"payee"===e.statut),x=a.filter(e=>"payee"!==e.statut),h=x.reduce((e,t)=>e+(Number(t.montant)||0),0),p=m.reduce((e,t)=>e+(Number(t.montant)||0),0),g=new Date().toISOString().slice(0,10),b=x.filter(e=>e.echeance&&e.echeance<g),f=new Date;f.setDate(f.getDate()+30);let j=x.filter(e=>e.echeance&&e.echeance<=f.toISOString().slice(0,10));a.sort((e,t)=>new Date(t.date||0)-new Date(e.date||0)),u({loading:!1,error:null,model:{commissions:{ceMois:l,caCeMois:c,tauxCommission:n,periode:i,commissionsAnnuelles:d},factures:{toutes:a,impayees:x,payees:m,enRetard:b},totaux:{montantImpaye:h,montantPaye:p,nombreImpayees:x.length,nombrePayees:m.length},alertes:{retard:b.length,prochainesEcheances:j.length},coord:s.coordonnees_facturation||{},partner:s}})}async function N(){try{var e,t,s,r;b(!0),j(null);let a=await fetch("/api/partenaires/".concat(c,"/invoices"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"preview",period:h.periode})}),n=await a.json().catch(()=>({}));if(!a.ok)throw Error(n.detail||n.error||"HTTP ".concat(a.status));let i=n.preview||{},l={periode:i.periode||i.period||h.periode,dossiers_count:null!=(t=null!=(e=i.dossiers_count)?e:i.dossiers)?t:0,commission_eur:null!=(r=null!=(s=i.commission_eur)?s:i.montant)?r:0};j(l)}catch(e){alert("❌ Aper\xe7u impossible: ".concat(e.message))}finally{b(!1)}}async function D(){try{b(!0);let e=await fetch("/api/partenaires/".concat(c,"/invoices"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"create",period:h.periode,echeance_jours:h.echeance_jours||30})}),t=await e.json().catch(()=>({}));if(!e.ok)throw Error(t.detail||t.error||"HTTP ".concat(e.status));alert("✅ Facture g\xe9n\xe9r\xe9e avec succ\xe8s"),x(!1),p({periode:new Date().toISOString().slice(0,7),echeance_jours:30}),j(t.preview||null),await y()}catch(e){console.error(e),alert("❌ Erreur: ".concat(e.message))}finally{b(!1)}}async function C(e){try{if(e.pdf&&e.pdf.startsWith("http"))return window.open(e.pdf,"_blank");let t=await fetch("/api/partenaires/".concat(c,"/invoices/").concat(e.id,"/pdf"));if(!t.ok)throw Error("Document non disponible");let s=await t.blob(),r=URL.createObjectURL(s),a=Object.assign(document.createElement("a"),{href:r,download:"facture_".concat(e.id,".pdf")});document.body.appendChild(a),a.click(),URL.revokeObjectURL(r),a.remove()}catch(e){console.error(e),alert("❌ Impossible de t\xe9l\xe9charger la facture")}}if((0,a.useEffect)(()=>{o?v(o):c&&y()},[c,o]),(0,a.useEffect)(()=>{if(!c)return;let e=new Date;if(1!==e.getUTCDate())return;let t=new Date(Date.UTC(e.getUTCFullYear(),e.getUTCMonth()-1,1)),s="".concat(t.getUTCFullYear(),"-").concat(String(t.getUTCMonth()+1).padStart(2,"0")),r="autoClose:".concat(c,":").concat(s);localStorage.getItem(r)||fetch("/api/partenaires/close-month",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({period:s,partnerId:c})}).then(()=>(localStorage.setItem(r,"1"),y())).catch(()=>{})},[c]),(0,a.useEffect)(()=>{j(null)},[h.periode]),d.loading&&!d.model)return(0,r.jsx)("section",{className:"bg-white border rounded-lg p-6",children:(0,r.jsx)("h3",{className:"text-lg font-semibold",children:"\uD83D\uDCB0 Facturation & Commissions"})});if(d.error)return(0,r.jsxs)("section",{className:"bg-white border rounded-lg p-6",children:[(0,r.jsx)("h3",{className:"text-lg font-semibold mb-4",children:"\uD83D\uDCB0 Facturation & Commissions"}),(0,r.jsxs)("div",{className:"bg-red-50 border border-red-200 rounded p-4",children:[(0,r.jsxs)("div",{className:"text-red-800",children:["❌ ",d.error]}),(0,r.jsx)("button",{onClick:y,className:"mt-2 text-sm bg-red-600 text-white px-3 py-1 rounded hover:bg-red-700",children:"\uD83D\uDD04 R\xe9essayer"})]})]});if(!d.model)return null;let w=d.model;return(0,r.jsxs)("section",{className:"bg-white border rounded-lg p-6",children:[(0,r.jsxs)("div",{className:"flex items-center justify-between mb-6",children:[(0,r.jsx)("h3",{className:"text-lg font-semibold",children:"\uD83D\uDCB0 Facturation & Commissions"}),(0,r.jsxs)("div",{className:"flex gap-2",children:[(0,r.jsx)("button",{onClick:y,className:"text-xs bg-blue-100 hover:bg-blue-200 text-blue-700 px-3 py-2 rounded-md",children:"\uD83D\uDD04 Actualiser"}),(0,r.jsx)("button",{onClick:()=>x(e=>!e),className:"text-sm bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700",children:m?"Annuler":"+ G\xe9n\xe9rer facture"})]})]}),(0,r.jsx)("button",{onClick:async()=>{try{let e=await fetch("/api/partenaires/close-month",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({period:new Date().toISOString().slice(0,7),partnerId:c})});if(!e.ok){let t=await e.json().catch(()=>({}));throw Error(t.details||t.error||"HTTP ".concat(e.status))}await y(),alert("✅ Facture cl\xf4tur\xe9e avec succ\xe8s !")}catch(e){alert("❌ Impossible de cl\xf4turer la facture : ".concat(e.message))}},className:"text-xs bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-2 rounded-md mb-6",children:"\uD83D\uDD12 Cl\xf4turer ce mois"}),(0,r.jsxs)("div",{className:"mb-6",children:[(0,r.jsx)("h4",{className:"text-sm font-medium text-gray-700 mb-3",children:"\uD83D\uDCB8 Commissions \xe0 recevoir"}),(0,r.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[(0,r.jsx)(l,{title:"Ce mois (temporaire)",value:"".concat(i(w.commissions.ceMois),"€"),subtitle:"CA: ".concat(i(w.commissions.caCeMois),"€")}),(0,r.jsx)(l,{title:"Taux commission",value:"".concat(i(w.commissions.tauxCommission),"%")}),(0,r.jsx)(l,{title:"P\xe9riode",value:w.commissions.periode,subtitle:"YYYY-MM"})]}),(0,r.jsx)("p",{className:"mt-2 text-xs text-gray-500",children:"Montant temporaire — la facture du mois pr\xe9c\xe9dent est g\xe9n\xe9r\xe9e et marqu\xe9e \xab pay\xe9e \xbb automatiquement le 1er du mois."})]}),(0,r.jsxs)("div",{className:"mb-6",children:[(0,r.jsx)("h4",{className:"text-sm font-medium text-gray-700 mb-3",children:"\uD83E\uDDFE \xc9tat facturation"}),(0,r.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[(0,r.jsx)(l,{title:"En attente",value:"".concat(i(w.totaux.montantImpaye),"€"),subtitle:"".concat(w.totaux.nombreImpayees," facture(s)")}),(0,r.jsx)(l,{title:"Pay\xe9",value:"".concat(i(w.totaux.montantPaye),"€"),subtitle:"".concat(w.totaux.nombrePayees," facture(s)")}),(0,r.jsx)(l,{title:"Total factures",value:w.factures.toutes.length,subtitle:"Historique"})]})]}),m&&(0,r.jsxs)("div",{className:"mb-6 p-4 bg-gray-50 border rounded-lg",children:[(0,r.jsx)("h4",{className:"font-medium mb-3",children:"G\xe9n\xe9rer une nouvelle facture"}),(0,r.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[(0,r.jsxs)("label",{className:"flex flex-col text-sm",children:[(0,r.jsx)("span",{className:"mb-1 font-medium",children:"P\xe9riode *"}),(0,r.jsx)("input",{type:"month",value:h.periode,onChange:e=>p(t=>({...t,periode:e.target.value})),className:"border rounded px-3 py-2"})]}),(0,r.jsxs)("label",{className:"flex flex-col text-sm",children:[(0,r.jsx)("span",{className:"mb-1 font-medium",children:"\xc9ch\xe9ance (jours)"}),(0,r.jsx)("input",{type:"number",min:"1",max:"90",value:h.echeance_jours,onChange:e=>p(t=>({...t,echeance_jours:parseInt(e.target.value||"0",10)})),className:"border rounded px-3 py-2"})]})]}),(0,r.jsxs)("div",{className:"flex gap-2 mt-4",children:[(0,r.jsx)("button",{onClick:N,disabled:g||!h.periode,className:"border px-4 py-2 rounded",children:g?"…":"\uD83D\uDC41️ Pr\xe9visualiser"}),(0,r.jsx)("button",{onClick:D,disabled:g||!h.periode,className:"bg-green-600 text-white px-4 py-2 rounded",children:g?"⏳ G\xe9n\xe9ration…":"✅ G\xe9n\xe9rer facture"}),(0,r.jsx)("button",{onClick:()=>x(!1),className:"border px-4 py-2 rounded",children:"Annuler"})]}),f&&(0,r.jsxs)("div",{className:"mt-4 text-sm text-gray-700",children:[(0,r.jsxs)("div",{children:["P\xe9riode : ",(0,r.jsx)("b",{children:f.periode})]}),(0,r.jsxs)("div",{children:["Dossiers pris en compte : ",(0,r.jsx)("b",{children:f.dossiers_count})]}),(0,r.jsxs)("div",{children:["Montant total commissions : ",(0,r.jsxs)("b",{children:[i(f.commission_eur),"€"]})]})]})]}),(0,r.jsxs)("div",{className:"mb-6",children:[(0,r.jsx)("h4",{className:"text-sm font-medium text-gray-700 mb-3",children:"\uD83D\uDCC4 Historique des factures"}),0===w.factures.toutes.length?(0,r.jsx)("div",{className:"text-center py-8 text-gray-500",children:"—"}):(0,r.jsxs)("div",{className:"overflow-x-auto",children:[(0,r.jsxs)("table",{className:"min-w-full",children:[(0,r.jsx)("thead",{className:"bg-gray-50",children:(0,r.jsxs)("tr",{children:[(0,r.jsx)("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase",children:"Facture"}),(0,r.jsx)("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase",children:"P\xe9riode"}),(0,r.jsx)("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase",children:"Montant"}),(0,r.jsx)("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase",children:"\xc9tat"}),(0,r.jsx)("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase",children:"\xc9ch\xe9ance"}),(0,r.jsx)("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase",children:"Actions"})]})}),(0,r.jsx)("tbody",{className:"bg-white divide-y divide-gray-200",children:w.factures.toutes.slice(0,10).map(e=>(0,r.jsxs)("tr",{className:"hover:bg-gray-50",children:[(0,r.jsxs)("td",{className:"px-4 py-4",children:[(0,r.jsxs)("div",{className:"font-medium text-gray-900",children:["#",e.id]}),(0,r.jsx)("div",{className:"text-xs text-gray-500",children:n(e.date)})]}),(0,r.jsx)("td",{className:"px-4 py-4 text-sm",children:e.periode||"—"}),(0,r.jsxs)("td",{className:"px-4 py-4 text-sm font-medium",children:[i(e.montant),"€"]}),(0,r.jsx)("td",{className:"px-4 py-4 text-sm",children:function(e){let t=function(e){if((null==e?void 0:e.statut)==="payee")return"Cl\xf4tur\xe9e";let t=new Date().toISOString().slice(0,7);return String(e.periode)<t?"Cl\xf4tur\xe9e":"Temporaire"}(e),[s,a]={Clôturée:["bg-green-100 text-green-800","✅ Cl\xf4tur\xe9e"],Temporaire:["bg-orange-100 text-orange-800","⏳ Temporaire"]}[t]||["bg-gray-100 text-gray-800","\uD83D\uDCCB ".concat(t)];return(0,r.jsx)("span",{className:"inline-flex items-center px-2 py-1 text-xs font-medium rounded-full ".concat(s),children:a})}(e)}),(0,r.jsxs)("td",{className:"px-4 py-4 text-sm",children:[(0,r.jsx)("div",{children:n(e.echeance)}),e.echeance&&new Date(e.echeance)<new Date&&"payee"!==e.statut&&(0,r.jsx)("div",{className:"text-xs text-red-600 font-medium",children:"En retard"})]}),(0,r.jsx)("td",{className:"px-4 py-4",children:(0,r.jsx)("button",{onClick:()=>C(e),className:"bg-blue-600 text-white px-3 py-1 rounded text-xs hover:bg-blue-700",children:"\uD83D\uDCE5 PDF"})})]},e.id))})]}),w.factures.toutes.length>10&&(0,r.jsxs)("div",{className:"text-center py-3 text-sm text-gray-500",children:["Et ",w.factures.toutes.length-10," autres factures…"]})]})]}),(0,r.jsxs)("div",{className:"bg-gray-50 rounded-lg p-4 text-sm",children:[(0,r.jsx)("h4",{className:"font-medium mb-2",children:"\uD83D\uDCEE Coordonn\xe9es de facturation"}),(0,r.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("div",{className:"font-medium",children:w.coord.societe||w.partner.nom||"—"}),(0,r.jsx)("div",{className:"text-gray-600",children:w.coord.adresse||"—"})]}),(0,r.jsxs)("div",{children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("strong",{children:"Email:"})," ",w.coord.email_facturation||"—"]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("strong",{children:"Mode paiement:"})," ",(null==(t=w.partner.paiement)?void 0:t.mode)||"—"]}),(null==(s=w.partner.paiement)?void 0:s.iban)&&(0,r.jsxs)("div",{children:[(0,r.jsx)("strong",{children:"IBAN:"})," ",w.partner.paiement.iban.slice(0,8),"…"]})]})]})]})]})}function l(e){let{title:t,value:s,subtitle:a}=e;return(0,r.jsxs)("div",{className:"bg-gray-50 border border-gray-200 rounded-lg p-4 text-center",children:[(0,r.jsx)("div",{className:"text-2xl font-bold text-gray-900",children:s}),(0,r.jsx)("div",{className:"text-sm font-medium text-gray-700",children:t}),a&&(0,r.jsx)("div",{className:"text-xs text-gray-500 mt-1",children:a})]})}}}]);