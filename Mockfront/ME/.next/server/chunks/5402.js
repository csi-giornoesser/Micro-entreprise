"use strict";exports.id=5402,exports.ids=[5402],exports.modules={18505:(a,b,c)=>{c.d(b,{A:()=>h});var d=c(21124),e=c(38301);let f=a=>a?new Date(a).toLocaleDateString("fr-FR"):"â€”",g=a=>0===a?"0":null!=a?Number(a).toLocaleString("fr-FR"):"â€”";function h({partnerId:a,data:b}){let[c,h]=(0,e.useState)({loading:!1,error:null,model:null}),[j,k]=(0,e.useState)(!1),[l,m]=(0,e.useState)({periode:new Date().toISOString().slice(0,7),echeance_jours:30}),[n,o]=(0,e.useState)(!1),[p,q]=(0,e.useState)(null);async function r(){try{h(a=>({...a,loading:!0,error:null}));let b=await fetch(`/api/partenaires/${a}`,{cache:"no-store"});if(!b.ok)throw Error(`HTTP ${b.status}`);!function(a){let b=a.partenaire||{},c=Array.isArray(a.ca_par_periode)?a.ca_par_periode:[],d=Array.isArray(a.factures)?[...a.factures]:[],e=Number(b.taux_commission)||0,f=new Date().toISOString().slice(0,7),g=Number(c.find(a=>a.periode===f)?.ca)||0,i=Number((g*e/100).toFixed(2)),j=new Date().getFullYear().toString(),k=Number((c.filter(a=>String(a.periode||"").startsWith(j)).reduce((a,b)=>a+(Number(b.ca)||0),0)*e/100).toFixed(2)),l=d.filter(a=>"payee"===a.statut),m=d.filter(a=>"payee"!==a.statut),n=m.reduce((a,b)=>a+(Number(b.montant)||0),0),o=l.reduce((a,b)=>a+(Number(b.montant)||0),0),p=new Date().toISOString().slice(0,10),q=m.filter(a=>a.echeance&&a.echeance<p),r=new Date;r.setDate(r.getDate()+30);let s=m.filter(a=>a.echeance&&a.echeance<=r.toISOString().slice(0,10));d.sort((a,b)=>new Date(b.date||0)-new Date(a.date||0)),h({loading:!1,error:null,model:{commissions:{ceMois:i,caCeMois:g,tauxCommission:e,periode:f,commissionsAnnuelles:k},factures:{toutes:d,impayees:m,payees:l,enRetard:q},totaux:{montantImpaye:n,montantPaye:o,nombreImpayees:m.length,nombrePayees:l.length},alertes:{retard:q.length,prochainesEcheances:s.length},coord:b.coordonnees_facturation||{},partner:b}})}(await b.json())}catch(a){console.error(a),h({loading:!1,error:"Impossible de charger les factures",model:null})}}async function s(){try{o(!0),q(null);let b=await fetch(`/api/partenaires/${a}/invoices`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"preview",period:l.periode})}),c=await b.json().catch(()=>({}));if(!b.ok)throw Error(c.detail||c.error||`HTTP ${b.status}`);let d=c.preview||{},e={periode:d.periode||d.period||l.periode,dossiers_count:d.dossiers_count??d.dossiers??0,commission_eur:d.commission_eur??d.montant??0};q(e)}catch(a){alert(`âŒ Aper\xe7u impossible: ${a.message}`)}finally{o(!1)}}async function t(){try{o(!0);let b=await fetch(`/api/partenaires/${a}/invoices`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"create",period:l.periode,echeance_jours:l.echeance_jours||30})}),c=await b.json().catch(()=>({}));if(!b.ok)throw Error(c.detail||c.error||`HTTP ${b.status}`);alert("âœ… Facture g\xe9n\xe9r\xe9e avec succ\xe8s"),k(!1),m({periode:new Date().toISOString().slice(0,7),echeance_jours:30}),q(c.preview||null),await r()}catch(a){console.error(a),alert(`âŒ Erreur: ${a.message}`)}finally{o(!1)}}async function u(b){try{if(b.pdf&&b.pdf.startsWith("http"))return window.open(b.pdf,"_blank");let c=await fetch(`/api/partenaires/${a}/invoices/${b.id}/pdf`);if(!c.ok)throw Error("Document non disponible");let d=await c.blob(),e=URL.createObjectURL(d),f=Object.assign(document.createElement("a"),{href:e,download:`facture_${b.id}.pdf`});document.body.appendChild(f),f.click(),URL.revokeObjectURL(e),f.remove()}catch(a){console.error(a),alert("âŒ Impossible de t\xe9l\xe9charger la facture")}}if(c.loading&&!c.model)return(0,d.jsx)("section",{className:"bg-white border rounded-lg p-6",children:(0,d.jsx)("h3",{className:"text-lg font-semibold",children:"\uD83D\uDCB0 Facturation & Commissions"})});if(c.error)return(0,d.jsxs)("section",{className:"bg-white border rounded-lg p-6",children:[(0,d.jsx)("h3",{className:"text-lg font-semibold mb-4",children:"\uD83D\uDCB0 Facturation & Commissions"}),(0,d.jsxs)("div",{className:"bg-red-50 border border-red-200 rounded p-4",children:[(0,d.jsxs)("div",{className:"text-red-800",children:["âŒ ",c.error]}),(0,d.jsx)("button",{onClick:r,className:"mt-2 text-sm bg-red-600 text-white px-3 py-1 rounded hover:bg-red-700",children:"\uD83D\uDD04 R\xe9essayer"})]})]});if(!c.model)return null;let v=c.model;return(0,d.jsxs)("section",{className:"bg-white border rounded-lg p-6",children:[(0,d.jsxs)("div",{className:"flex items-center justify-between mb-6",children:[(0,d.jsx)("h3",{className:"text-lg font-semibold",children:"\uD83D\uDCB0 Facturation & Commissions"}),(0,d.jsxs)("div",{className:"flex gap-2",children:[(0,d.jsx)("button",{onClick:r,className:"text-xs bg-blue-100 hover:bg-blue-200 text-blue-700 px-3 py-2 rounded-md",children:"\uD83D\uDD04 Actualiser"}),(0,d.jsx)("button",{onClick:()=>k(a=>!a),className:"text-sm bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700",children:j?"Annuler":"+ G\xe9n\xe9rer facture"})]})]}),(0,d.jsx)("button",{onClick:async()=>{try{let b=await fetch("/api/partenaires/close-month",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({period:new Date().toISOString().slice(0,7),partnerId:a})});if(!b.ok){let a=await b.json().catch(()=>({}));throw Error(a.details||a.error||`HTTP ${b.status}`)}await r(),alert("âœ… Facture cl\xf4tur\xe9e avec succ\xe8s !")}catch(a){alert(`âŒ Impossible de cl\xf4turer la facture : ${a.message}`)}},className:"text-xs bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-2 rounded-md mb-6",children:"\uD83D\uDD12 Cl\xf4turer ce mois"}),(0,d.jsxs)("div",{className:"mb-6",children:[(0,d.jsx)("h4",{className:"text-sm font-medium text-gray-700 mb-3",children:"\uD83D\uDCB8 Commissions \xe0 recevoir"}),(0,d.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[(0,d.jsx)(i,{title:"Ce mois (temporaire)",value:`${g(v.commissions.ceMois)}â‚¬`,subtitle:`CA: ${g(v.commissions.caCeMois)}â‚¬`}),(0,d.jsx)(i,{title:"Taux commission",value:`${g(v.commissions.tauxCommission)}%`}),(0,d.jsx)(i,{title:"P\xe9riode",value:v.commissions.periode,subtitle:"YYYY-MM"})]}),(0,d.jsx)("p",{className:"mt-2 text-xs text-gray-500",children:"Montant temporaire â€” la facture du mois pr\xe9c\xe9dent est g\xe9n\xe9r\xe9e et marqu\xe9e \xab pay\xe9e \xbb automatiquement le 1er du mois."})]}),(0,d.jsxs)("div",{className:"mb-6",children:[(0,d.jsx)("h4",{className:"text-sm font-medium text-gray-700 mb-3",children:"\uD83E\uDDFE \xc9tat facturation"}),(0,d.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[(0,d.jsx)(i,{title:"En attente",value:`${g(v.totaux.montantImpaye)}â‚¬`,subtitle:`${v.totaux.nombreImpayees} facture(s)`}),(0,d.jsx)(i,{title:"Pay\xe9",value:`${g(v.totaux.montantPaye)}â‚¬`,subtitle:`${v.totaux.nombrePayees} facture(s)`}),(0,d.jsx)(i,{title:"Total factures",value:v.factures.toutes.length,subtitle:"Historique"})]})]}),j&&(0,d.jsxs)("div",{className:"mb-6 p-4 bg-gray-50 border rounded-lg",children:[(0,d.jsx)("h4",{className:"font-medium mb-3",children:"G\xe9n\xe9rer une nouvelle facture"}),(0,d.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[(0,d.jsxs)("label",{className:"flex flex-col text-sm",children:[(0,d.jsx)("span",{className:"mb-1 font-medium",children:"P\xe9riode *"}),(0,d.jsx)("input",{type:"month",value:l.periode,onChange:a=>m(b=>({...b,periode:a.target.value})),className:"border rounded px-3 py-2"})]}),(0,d.jsxs)("label",{className:"flex flex-col text-sm",children:[(0,d.jsx)("span",{className:"mb-1 font-medium",children:"\xc9ch\xe9ance (jours)"}),(0,d.jsx)("input",{type:"number",min:"1",max:"90",value:l.echeance_jours,onChange:a=>m(b=>({...b,echeance_jours:parseInt(a.target.value||"0",10)})),className:"border rounded px-3 py-2"})]})]}),(0,d.jsxs)("div",{className:"flex gap-2 mt-4",children:[(0,d.jsx)("button",{onClick:s,disabled:n||!l.periode,className:"border px-4 py-2 rounded",children:n?"â€¦":"\uD83D\uDC41ï¸ Pr\xe9visualiser"}),(0,d.jsx)("button",{onClick:t,disabled:n||!l.periode,className:"bg-green-600 text-white px-4 py-2 rounded",children:n?"â³ G\xe9n\xe9rationâ€¦":"âœ… G\xe9n\xe9rer facture"}),(0,d.jsx)("button",{onClick:()=>k(!1),className:"border px-4 py-2 rounded",children:"Annuler"})]}),p&&(0,d.jsxs)("div",{className:"mt-4 text-sm text-gray-700",children:[(0,d.jsxs)("div",{children:["P\xe9riode : ",(0,d.jsx)("b",{children:p.periode})]}),(0,d.jsxs)("div",{children:["Dossiers pris en compte : ",(0,d.jsx)("b",{children:p.dossiers_count})]}),(0,d.jsxs)("div",{children:["Montant total commissions : ",(0,d.jsxs)("b",{children:[g(p.commission_eur),"â‚¬"]})]})]})]}),(0,d.jsxs)("div",{className:"mb-6",children:[(0,d.jsx)("h4",{className:"text-sm font-medium text-gray-700 mb-3",children:"\uD83D\uDCC4 Historique des factures"}),0===v.factures.toutes.length?(0,d.jsx)("div",{className:"text-center py-8 text-gray-500",children:"â€”"}):(0,d.jsxs)("div",{className:"overflow-x-auto",children:[(0,d.jsxs)("table",{className:"min-w-full",children:[(0,d.jsx)("thead",{className:"bg-gray-50",children:(0,d.jsxs)("tr",{children:[(0,d.jsx)("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase",children:"Facture"}),(0,d.jsx)("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase",children:"P\xe9riode"}),(0,d.jsx)("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase",children:"Montant"}),(0,d.jsx)("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase",children:"\xc9tat"}),(0,d.jsx)("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase",children:"\xc9ch\xe9ance"}),(0,d.jsx)("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase",children:"Actions"})]})}),(0,d.jsx)("tbody",{className:"bg-white divide-y divide-gray-200",children:v.factures.toutes.slice(0,10).map(a=>(0,d.jsxs)("tr",{className:"hover:bg-gray-50",children:[(0,d.jsxs)("td",{className:"px-4 py-4",children:[(0,d.jsxs)("div",{className:"font-medium text-gray-900",children:["#",a.id]}),(0,d.jsx)("div",{className:"text-xs text-gray-500",children:f(a.date)})]}),(0,d.jsx)("td",{className:"px-4 py-4 text-sm",children:a.periode||"â€”"}),(0,d.jsxs)("td",{className:"px-4 py-4 text-sm font-medium",children:[g(a.montant),"â‚¬"]}),(0,d.jsx)("td",{className:"px-4 py-4 text-sm",children:function(a){let b=function(a){if(a?.statut==="payee")return"Cl\xf4tur\xe9e";let b=new Date().toISOString().slice(0,7);return String(a.periode)<b?"Cl\xf4tur\xe9e":"Temporaire"}(a),[c,e]={ClÃ´turÃ©e:["bg-green-100 text-green-800","âœ… Cl\xf4tur\xe9e"],Temporaire:["bg-orange-100 text-orange-800","â³ Temporaire"]}[b]||["bg-gray-100 text-gray-800",`ðŸ“‹ ${b}`];return(0,d.jsx)("span",{className:`inline-flex items-center px-2 py-1 text-xs font-medium rounded-full ${c}`,children:e})}(a)}),(0,d.jsxs)("td",{className:"px-4 py-4 text-sm",children:[(0,d.jsx)("div",{children:f(a.echeance)}),a.echeance&&new Date(a.echeance)<new Date&&"payee"!==a.statut&&(0,d.jsx)("div",{className:"text-xs text-red-600 font-medium",children:"En retard"})]}),(0,d.jsx)("td",{className:"px-4 py-4",children:(0,d.jsx)("button",{onClick:()=>u(a),className:"bg-blue-600 text-white px-3 py-1 rounded text-xs hover:bg-blue-700",children:"\uD83D\uDCE5 PDF"})})]},a.id))})]}),v.factures.toutes.length>10&&(0,d.jsxs)("div",{className:"text-center py-3 text-sm text-gray-500",children:["Et ",v.factures.toutes.length-10," autres facturesâ€¦"]})]})]}),(0,d.jsxs)("div",{className:"bg-gray-50 rounded-lg p-4 text-sm",children:[(0,d.jsx)("h4",{className:"font-medium mb-2",children:"\uD83D\uDCEE Coordonn\xe9es de facturation"}),(0,d.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[(0,d.jsxs)("div",{children:[(0,d.jsx)("div",{className:"font-medium",children:v.coord.societe||v.partner.nom||"â€”"}),(0,d.jsx)("div",{className:"text-gray-600",children:v.coord.adresse||"â€”"})]}),(0,d.jsxs)("div",{children:[(0,d.jsxs)("div",{children:[(0,d.jsx)("strong",{children:"Email:"})," ",v.coord.email_facturation||"â€”"]}),(0,d.jsxs)("div",{children:[(0,d.jsx)("strong",{children:"Mode paiement:"})," ",v.partner.paiement?.mode||"â€”"]}),v.partner.paiement?.iban&&(0,d.jsxs)("div",{children:[(0,d.jsx)("strong",{children:"IBAN:"})," ",v.partner.paiement.iban.slice(0,8),"â€¦"]})]})]})]})]})}function i({title:a,value:b,subtitle:c}){return(0,d.jsxs)("div",{className:"bg-gray-50 border border-gray-200 rounded-lg p-4 text-center",children:[(0,d.jsx)("div",{className:"text-2xl font-bold text-gray-900",children:b}),(0,d.jsx)("div",{className:"text-sm font-medium text-gray-700",children:a}),c&&(0,d.jsx)("div",{className:"text-xs text-gray-500 mt-1",children:c})]})}},30562:(a,b,c)=>{c.d(b,{A:()=>f});var d=c(21124),e=c(38301);function f({clientId:a,dossiers:b,senderType:c="Op\xe9rateur"}){let[f,g]=(0,e.useState)(null),[h,i]=(0,e.useState)([]),[j,k]=(0,e.useState)(""),[l,m]=(0,e.useState)(!1),[n,o]=(0,e.useState)(!1),p="Client"===c,q="Op\xe9rateur"===c;async function r(){if(j.trim()&&f){m(!0);try{let a=await fetch(`/api/dossiers/${f.id}/messages`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({sender_type:c,body:j.trim(),send_email:q})});if(!a.ok)throw Error(`HTTP ${a.status}`);let b=await a.json();i(a=>[...a,b.message]),k(""),q&&b.email_sent?alert(`Message envoy\xe9 et email automatique exp\xe9di\xe9 \xe0 ${b.client_email}`):p&&alert("Message envoy\xe9 \xe0 l'\xe9quipe !")}catch(a){console.error("Erreur envoi message:",a),alert("Erreur lors de l'envoi du message")}finally{m(!1)}}}return 0===b.length?(0,d.jsxs)("section",{className:"border rounded p-4",children:[(0,d.jsx)("h3",{className:"text-lg font-semibold mb-3",children:"\uD83D\uDCAC Messagerie"}),(0,d.jsxs)("p",{className:"text-gray-600",children:["Aucun dossier trouv\xe9",p?"":" pour ce client","."]})]}):(0,d.jsxs)("section",{className:"border rounded p-4 space-y-4",children:[(0,d.jsxs)("h3",{className:"text-lg font-semibold",children:["\uD83D\uDCAC ",p?"Messagerie avec votre \xe9quipe":"Messagerie Client",(0,d.jsx)("span",{className:"text-sm font-normal text-gray-600 ml-2",children:p?"(Communication avec nos op\xe9rateurs)":"(Communication directe avec le client)"})]}),b.length>1&&(0,d.jsxs)("div",{children:[(0,d.jsx)("label",{className:"block text-sm font-medium mb-1",children:"Dossier \xe0 afficher :"}),(0,d.jsx)("select",{className:"border rounded p-2",value:f?.id||"",onChange:a=>{g(b.find(b=>b.id===parseInt(a.target.value)))},children:b.map(a=>(0,d.jsxs)("option",{value:a.id,children:["Dossier #",a.id," - ",a.statut]},a.id))})]}),f&&(0,d.jsxs)(d.Fragment,{children:[(0,d.jsxs)("div",{className:"text-sm bg-blue-50 p-2 rounded",children:["\uD83D\uDCC1 ",(0,d.jsxs)("strong",{children:["Dossier #",f.id]})," - Statut: ",f.statut]}),(0,d.jsx)("div",{className:"space-y-3 max-h-96 overflow-y-auto",children:n?(0,d.jsx)("p",{className:"text-gray-600",children:"Chargement des messages..."}):0===h.length?(0,d.jsx)("p",{className:"text-gray-600",children:"Aucun message pour ce dossier."}):h.map(a=>{var b;let c;return(0,d.jsxs)("div",{className:`p-3 rounded ${(a=>{switch(a){case"Client":return"bg-blue-50 border-l-4 border-l-blue-500";case"Op\xe9rateur":return"bg-green-50 border-l-4 border-l-green-500";case"Syst\xe8me":return"bg-gray-50 border-l-4 border-l-gray-500";default:return"bg-gray-50"}})(a.sender_type)}`,children:[(0,d.jsxs)("div",{className:"flex items-center justify-between mb-1",children:[(0,d.jsxs)("div",{className:"flex items-center gap-2",children:[(0,d.jsx)("span",{children:(a=>{switch(a){case"Client":return"\uD83D\uDC64";case"Op\xe9rateur":return"\uD83D\uDC68â€\uD83D\uDCBC";case"Syst\xe8me":return"\uD83E\uDD16";default:return"\uD83D\uDCAC"}})(a.sender_type)}),(0,d.jsx)("strong",{className:"text-sm",children:(b=a.sender_type,p?"Client"===b?"Vous":"Op\xe9rateur"===b?"\xc9quipe":b:b)})]}),(0,d.jsx)("span",{className:"text-xs text-gray-600",children:(c=a.at)?new Date(c).toLocaleString("fr-FR"):"-"})]}),(0,d.jsx)("div",{className:"whitespace-pre-wrap",children:a.body})]},a.id)})}),(0,d.jsxs)("div",{className:"border-t pt-4 space-y-3",children:[(0,d.jsx)("h4",{className:"font-medium",children:p?"âœ‰ï¸ Envoyer un message \xe0 l'\xe9quipe":"âœ‰ï¸ R\xe9pondre au client"}),(0,d.jsx)("textarea",{className:"w-full border rounded p-3 h-24",placeholder:p?"Votre message \xe0 l'\xe9quipe...":"Votre message sera envoy\xe9 au client par email...",value:j,onChange:a=>k(a.target.value),disabled:l}),(0,d.jsxs)("div",{className:"flex gap-2",children:[(0,d.jsx)("button",{className:"bg-blue-600 text-white px-4 py-2 rounded disabled:opacity-50",onClick:r,disabled:l||!j.trim(),children:l?"Envoi...":p?"\uD83D\uDCE4 Envoyer \xe0 l'\xe9quipe":"\uD83D\uDCE7 Envoyer au client"}),(0,d.jsx)("button",{className:"border px-4 py-2 rounded",onClick:()=>k(""),disabled:l,children:"Effacer"})]}),(0,d.jsxs)("p",{className:"text-xs text-gray-600",children:["\uD83D\uDCA1 ",p?"Votre message sera envoy\xe9 \xe0 l'\xe9quipe et ajout\xe9 \xe0 l'historique de votre dossier.":"Le message sera ajout\xe9 \xe0 l'historique et envoy\xe9 automatiquement par email au client."]})]})]})]})}}};